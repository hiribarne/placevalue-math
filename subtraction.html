<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Place Value Subtraction</title>
<style>
:root {
  --unit-size: 28px;
  --rod-width: 28px;
  --rod-height: 140px;
  --flat-size: 140px;
  --color-unit: #4A90D9;
  --color-rod: #7BC67E;
  --color-flat: #F5A623;
  --color-bg: #F7F3EE;
  --color-header: #5B4A8A;
  --color-accent: #E8573A;
  --color-success: #4CAF50;
  --color-text: #333;
  --color-light-text: #777;
  --color-border: #ccc;
  --color-mat-bg: #FAFAF5;
  --color-mat-header: #EDE8E0;
  --color-galera-bg: #fff;
  --radius: 4px;
  --shadow-block: 1px 2px 4px rgba(0,0,0,0.18);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--color-bg);
  color: var(--color-text);
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
  overflow-x: hidden;
}

/* ── Header ── */
.header {
  background: var(--color-header);
  color: #fff;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}
.header h1 { font-size: 1.3rem; font-weight: 700; margin-right: auto; }
.header select, .header button {
  font-size: 0.95rem; padding: 8px 14px; border: none;
  border-radius: 6px; cursor: pointer; min-height: 44px;
}
.header select {
  background: rgba(255,255,255,0.2); color: #fff;
  appearance: none; -webkit-appearance: none; padding-right: 28px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='white' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
.header select option { color: #333; background: #fff; }
.btn-new { background: var(--color-accent); color: #fff; font-weight: 600; }
.btn-new:active { transform: scale(0.96); }
.btn-home {
  background: rgba(255,255,255,0.2); color: #fff; font-weight: 600;
  text-decoration: none; display: inline-flex; align-items: center; gap: 4px;
  font-size: 0.95rem; padding: 8px 14px; border-radius: 6px; min-height: 44px;
}
.btn-home:active { transform: scale(0.96); }

/* ── Main Layout ── */
.main {
  display: flex; flex-direction: column; align-items: center;
  gap: 24px; padding: 20px;
  max-width: 700px; margin: 0 auto;
}

/* ── Galera Section ── */
.galera-section {
  display: flex; flex-direction: column; align-items: center; gap: 16px;
  width: 100%;
}
.galera {
  background: var(--color-galera-bg); border: 2px solid var(--color-border);
  border-radius: 14px; padding: 28px 32px; display: inline-block;
}
.galera-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.galera-row.carry-row { margin-bottom: 2px; }
.galera-row.divider {
  border-bottom: 3px solid var(--color-text); padding-bottom: 8px; margin-bottom: 8px;
}
.galera-label {
  width: 32px; text-align: center; font-size: 1.6rem;
  font-weight: 700; color: var(--color-light-text);
}
.galera-cell {
  width: 72px; height: 72px; border: 2px solid var(--color-border);
  border-radius: 8px; text-align: center; font-size: 2.2rem; font-weight: 700;
  font-family: 'Courier New', monospace; background: #fff;
  color: var(--color-text); outline: none;
  -webkit-appearance: none; appearance: none;
}
.galera-cell:focus {
  border-color: var(--color-header); box-shadow: 0 0 0 3px rgba(91,74,138,0.2);
}
.galera-cell.readonly { background: #f5f5f5; cursor: default; }
.galera-carry-slot { width: 72px; display: flex; justify-content: center; }
.galera-cell.carry {
  width: 44px; height: 44px; font-size: 1.3rem; font-weight: 700;
  border: 2px solid #d4b896; color: var(--color-accent); background: #FFF8F0;
}
.galera-cell.carry:focus {
  border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(232,87,58,0.15);
}
.galera-cell.correct { border-color: var(--color-success); background: #F0FFF0; }
.galera-cell.incorrect {
  border-color: var(--color-accent); background: #FFF0F0; animation: shake 0.4s ease;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}
.galera-col-header {
  text-align: center; font-size: 0.85rem; color: var(--color-light-text); width: 72px;
  font-weight: 600;
}

/* Check button */
.btn-check {
  background: var(--color-success); color: #fff; padding: 14px 36px;
  font-size: 1.15rem; font-weight: 700; border: none; border-radius: 10px;
  cursor: pointer; min-height: 48px; width: 100%; max-width: 280px;
  transition: transform 0.15s ease;
}
.btn-check:active { transform: scale(0.96); }
.btn-check:disabled { opacity: 0.4; cursor: not-allowed; }
.galera-buttons { display: flex; gap: 10px; width: 100%; max-width: 280px; }
.galera-buttons .btn-check { flex: 1; }
.btn-clear {
  background: #fff; color: var(--color-light-text); padding: 14px 16px;
  font-size: 1.15rem; font-weight: 700; border: 2px solid var(--color-border);
  border-radius: 10px; cursor: pointer; min-height: 48px;
  transition: transform 0.15s ease;
}
.btn-clear:active { transform: scale(0.96); }

/* Guide Me */
.btn-guide { background: #6C5CE7; color: #fff; font-weight: 600; }
.btn-guide:active { transform: scale(0.96); }
.btn-guide.active { background: #A29BFE; }
.guide-prompt {
  background: #6C5CE7; color: #fff; padding: 12px 20px; border-radius: 10px;
  font-size: 1.15rem; font-weight: 600; text-align: center;
  width: 100%; max-width: 380px; display: none; line-height: 1.4;
  align-items: center; gap: 10px; justify-content: center;
}
.guide-prompt.show { display: flex; }
#guideInput {
  width: 60px; height: 44px; text-align: center; font-size: 1.4rem;
  font-weight: 700; font-family: 'Courier New', monospace;
  border: 2px solid rgba(255,255,255,0.4); border-radius: 8px;
  background: #fff; color: var(--color-text); outline: none;
  -webkit-appearance: none; appearance: none; flex-shrink: 0;
}
#guideInput:focus {
  border-color: #fff; box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}
#guideInput.correct { border-color: var(--color-success); background: #F0FFF0; }
#guideInput.incorrect {
  border-color: var(--color-accent); background: #FFF0F0; animation: shake 0.4s ease;
}
.galera-cell.guide-active {
  border-color: #6C5CE7 !important;
  box-shadow: 0 0 0 3px rgba(108,92,231,0.25) !important;
}
.galera-cell-wrap { position: relative; }
.borrow-indicator {
  position: absolute; top: 4px; left: 6px;
  font-size: 0.85rem; font-weight: 800; color: var(--color-accent);
  font-family: 'Courier New', monospace; pointer-events: none;
  z-index: 5; line-height: 1;
}
.guide-borrow-btn {
  background: #fff; color: #6C5CE7; border: 2px solid rgba(255,255,255,0.4);
  border-radius: 8px; padding: 8px 18px; font-size: 1.1rem; font-weight: 700;
  cursor: pointer; min-height: 44px; flex-shrink: 0;
  animation: borrowBtnPulse 1.2s ease infinite;
}
.guide-borrow-btn:active { transform: scale(0.95); }
@keyframes borrowBtnPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0.6); }
  50% { box-shadow: 0 0 0 6px rgba(255,255,255,0); }
}

/* ── Mat Section (collapsible) ── */
.mat-section { display: flex; flex-direction: column; gap: 0; width: 100%; }
.mat-toggle {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  background: var(--color-mat-header); border: 2px solid #c4b89a;
  border-radius: 10px 10px 0 0; padding: 12px 16px; cursor: pointer;
  font-size: 0.9rem; font-weight: 700; color: var(--color-text);
  user-select: none; -webkit-user-select: none;
}
.mat-toggle .arrow {
  display: inline-block; transition: transform 0.25s ease; font-size: 0.7rem;
}
.mat-section.collapsed .mat-toggle { border-radius: 10px; }
.mat-section.collapsed .arrow { transform: rotate(-90deg); }
.mat-body {
  overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease;
  max-height: 2000px; opacity: 1;
}
.mat-section.collapsed .mat-body { max-height: 0; opacity: 0; }

.mat {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  border: 2px solid #c4b89a; border-top: none;
  overflow: hidden; background: var(--color-mat-bg);
}
.mat-header {
  background: var(--color-mat-header); padding: 6px 4px;
  text-align: center; font-weight: 700; font-size: 0.8rem;
  border-bottom: 2px solid #c4b89a;
}
.mat-header small { display: block; font-weight: 400; font-size: 0.7rem; color: var(--color-light-text); }
.mat-cell {
  border: 1px solid #e0dbd2; padding: 6px; min-height: 60px;
  display: flex; flex-wrap: wrap; align-content: flex-start;
  gap: 3px; position: relative;
}
.mat-cell.hundreds-col { background: rgba(245,166,35,0.05); }
.mat-cell.tens-col     { background: rgba(123,198,126,0.05); }
.mat-cell.ones-col     { background: rgba(74,144,217,0.05); }
.mat-row-label {
  position: absolute; top: 2px; left: 4px;
  font-size: 0.6rem; color: var(--color-light-text); pointer-events: none;
}
.mat-cell.row-subtrahend { border-top: 2px solid #c4b89a; }
.mat-cell.row-result     { border-top: 3px solid #c4b89a; }

/* ── Counter bar ── */
.count-bar {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  border: 2px solid #c4b89a; border-top: 2px dashed #c4b89a;
  background: #f0ede6;
}
.count-cell {
  padding: 6px 4px; text-align: center; font-size: 0.8rem;
  font-weight: 700; color: var(--color-light-text);
  border-right: 1px solid #e0dbd2;
}
.count-cell:last-child { border-right: none; }
.count-cell .count-num {
  font-size: 1.2rem; color: var(--color-text); display: block; line-height: 1;
}
.count-total {
  grid-column: 1 / -1; text-align: center; padding: 5px 4px;
  font-size: 0.8rem; color: var(--color-light-text);
  border-top: 1px solid #d5d0c7;
}
.count-total .count-formed {
  font-size: 1.1rem; font-weight: 800; color: var(--color-header);
  margin-left: 4px; font-family: 'Courier New', monospace;
}

/* Mat actions + bottom border */
.mat-actions-wrap {
  border: 2px solid #c4b89a; border-top: none;
  border-radius: 0 0 10px 10px; background: var(--color-mat-bg);
  padding: 10px; display: flex; gap: 8px; justify-content: center;
}

/* ── Blocks ── */
.block {
  border-radius: var(--radius); box-shadow: var(--shadow-block);
  flex-shrink: 0; cursor: pointer; position: relative;
}
.block.unit {
  width: var(--unit-size); height: var(--unit-size);
  background: var(--color-unit); border: 1px solid #3a7bc0;
}
.block.rod {
  width: var(--rod-width); height: var(--rod-height);
  background: var(--color-rod); border: 1px solid #5ea862;
  background-image: repeating-linear-gradient(
    to bottom, transparent, transparent 13px,
    rgba(0,0,0,0.12) 13px, rgba(0,0,0,0.12) 14px
  );
}
.block.flat {
  width: var(--flat-size); height: var(--flat-size);
  background: var(--color-flat); border: 1px solid #d4901c;
  background-image:
    repeating-linear-gradient(to bottom, transparent, transparent 13px,
      rgba(0,0,0,0.10) 13px, rgba(0,0,0,0.10) 14px),
    repeating-linear-gradient(to right, transparent, transparent 13px,
      rgba(0,0,0,0.10) 13px, rgba(0,0,0,0.10) 14px);
}

/* Block counting */
.block.counted { opacity: 0.45; }
.block.counted::after {
  content: '\2713'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-weight: 900; font-size: 1em;
  text-shadow: 0 1px 3px rgba(0,0,0,0.6); pointer-events: none;
}
.block.unit.counted::after { font-size: 0.85em; }
.block.rod.counted::after  { font-size: 1.4em; }
.block.flat.counted::after { font-size: 3em; }

/* Block animations — ORDER MATTERS (later wins) */
.block.entrance { animation: blockEntrance 0.35s ease-out forwards; }
@keyframes blockEntrance {
  from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; }
}
.block.slide-down { animation: slideDown 0.5s ease forwards; }
@keyframes slideDown {
  from { transform: translateY(-40px); opacity: 0.5; } to { transform: translateY(0); opacity: 1; }
}
.block.highlight { animation: blockHighlight 0.6s ease infinite; }
@keyframes blockHighlight {
  0%, 100% { box-shadow: 0 0 0 0 rgba(232,87,58,0.4); }
  50%      { box-shadow: 0 0 0 6px rgba(232,87,58,0.15); }
}
.block.shrink-away { animation: shrinkAway 0.4s ease forwards; }
@keyframes shrinkAway { to { transform: scale(0); opacity: 0; } }
.block.pop-in { animation: popIn 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards; }
@keyframes popIn {
  from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; }
}

/* ── Mat buttons ── */
.btn {
  padding: 10px 20px; font-size: 1rem; font-weight: 700; border: none;
  border-radius: 8px; cursor: pointer; min-height: 44px;
  transition: transform 0.15s ease;
}
.btn:active { transform: scale(0.96); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
.btn-subtract { background: var(--color-header); color: #fff; }
.btn-borrow { background: var(--color-accent); color: #fff; display: none; }
.btn-borrow.show {
  display: inline-block;
  animation: borrowBtnPulse 0.8s ease infinite;
}
@keyframes borrowBtnPulse {
  0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(232,87,58,0.6); }
  50%      { transform: scale(1.06); box-shadow: 0 0 0 12px rgba(232,87,58,0); }
}

/* ── BORROW NEEDED — very noticeable ── */
.mat-cell.needs-borrow {
  animation: borrowFlash 0.7s ease infinite;
  border: 3px solid var(--color-accent);
  z-index: 1;
}
@keyframes borrowFlash {
  0%, 100% {
    background: rgba(232,87,58,0.08);
    box-shadow: inset 0 0 12px rgba(232,87,58,0.15), 0 0 0 0 rgba(232,87,58,0.3);
  }
  50% {
    background: rgba(232,87,58,0.22);
    box-shadow: inset 0 0 20px rgba(232,87,58,0.25), 0 0 0 8px rgba(232,87,58,0.08);
  }
}
.borrow-badge {
  position: absolute; top: -10px; right: -10px;
  background: var(--color-accent); color: #fff; font-size: 0.65rem; font-weight: 800;
  padding: 3px 6px; border-radius: 8px; white-space: nowrap;
  animation: badgeBounce 0.7s ease infinite; z-index: 2;
  pointer-events: none;
}
@keyframes badgeBounce {
  0%, 100% { transform: translateY(0); }
  50%      { transform: translateY(-4px); }
}

/* ── Feedback ── */
.feedback-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  display: none; align-items: flex-start; justify-content: center;
  padding-top: 18vh;
  z-index: 100; pointer-events: none;
}
.feedback-overlay.show { display: flex; }
.feedback-message {
  font-size: 2.2rem; font-weight: 800; color: #fff;
  background: var(--color-success); padding: 16px 40px; border-radius: 16px;
  box-shadow: 0 8px 32px rgba(76,175,80,0.4);
  pointer-events: none;
  animation: bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes bounceIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.hint-toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: #FFF3CD; color: #856404; padding: 14px 28px; border-radius: 10px;
  font-size: 1.1rem; font-weight: 600; box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  z-index: 100; animation: toastIn 0.35s ease; pointer-events: none; white-space: nowrap;
}
@keyframes toastIn {
  from { transform: translateX(-50%) translateY(20px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0); opacity: 1; }
}
.hint-toast.fade-out { animation: toastOut 0.3s ease forwards; }
@keyframes toastOut { to { transform: translateX(-50%) translateY(20px); opacity: 0; } }

.confetti-piece {
  position: fixed; top: -10px; width: 10px; height: 10px;
  border-radius: 2px; z-index: 101; pointer-events: none;
}

/* ── Responsive ── */
@media (max-width: 768px) {
  :root { --unit-size:22px; --rod-width:22px; --rod-height:110px; --flat-size:110px; }
  .header { padding: 10px 14px; gap: 8px; }
  .header h1 { font-size: 1.1rem; width: 100%; }
  .main { padding: 12px; gap: 16px; }
  .galera { padding: 20px; }
  .galera-cell { width: 60px; height: 60px; font-size: 1.9rem; }
  .galera-carry-slot { width: 60px; }
  .galera-cell.carry { width: 38px; height: 38px; font-size: 1.1rem; }
  .galera-col-header { width: 60px; }
  .galera-row { gap: 6px; }
  .galera-label { width: 28px; font-size: 1.4rem; }
}
@media (max-width: 480px) {
  :root { --unit-size:18px; --rod-width:18px; --rod-height:90px; --flat-size:90px; }
  .galera-cell { width: 50px; height: 50px; font-size: 1.5rem; }
  .galera-carry-slot { width: 50px; }
  .galera-cell.carry { width: 32px; height: 32px; font-size: 1rem; }
  .galera-col-header { width: 50px; }
  .galera-row { gap: 4px; }
  .galera-label { width: 24px; font-size: 1.3rem; }
  .btn { padding: 10px 16px; font-size: 0.95rem; }
  .btn-check { font-size: 1.05rem; padding: 12px 28px; }
}

/* ── Narration Bar ── */
.narration-bar {
  display: none; align-items: center; gap: 12px;
  background: linear-gradient(135deg, #6C5CE7, #a855f7);
  color: #fff; padding: 14px 20px; border-radius: 12px;
  width: 100%; max-width: 380px;
  box-shadow: 0 4px 12px rgba(108,92,231,0.3);
  min-height: 60px;
}
.narration-bar.visible { display: flex; }
.narration-icon {
  font-size: 1.8rem; flex-shrink: 0;
  animation: iconBob 2s ease-in-out infinite;
}
@keyframes iconBob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
.narration-text {
  flex: 1; font-size: 1.15rem; font-weight: 600;
  line-height: 1.3; transition: opacity 0.3s ease;
}
/* ── Movement Arrows ── */
.movement-arrow {
  position: absolute; top: 0; left: 0;
  pointer-events: none; z-index: 10; overflow: visible;
}
.movement-arrow path {
  animation: arrowFadeIn 0.4s ease forwards, arrowMarch 0.8s linear infinite;
}
@keyframes arrowFadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes arrowMarch { to { stroke-dashoffset: -24; } }

/* ── Galera borrow animations ── */
.floating-digit {
  position: fixed; z-index: 200; pointer-events: none;
  font-size: 1.5rem; font-weight: 800; color: var(--color-accent);
  font-family: 'Courier New', monospace;
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.galera-cell.carry-bounce {
  animation: carryBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes carryBounce {
  0% { transform: scale(0.3); opacity: 0; }
  60% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}
.galera-strike {
  pointer-events: none; z-index: 50;
  transition: width 0.3s ease;
}

/* ── Narration responsive ── */
@media (max-width: 768px) {
  .narration-bar { max-width: 100%; padding: 12px 16px; }
  .narration-text { font-size: 1.05rem; }
}
@media (max-width: 480px) {
  .narration-bar { padding: 10px 12px; gap: 8px; }
  .narration-icon { font-size: 1.4rem; }
  .narration-text { font-size: 0.95rem; }
}
</style>
</head>
<body>

<div class="header">
  <h1>Place Value Subtraction</h1>
  <a class="btn-home" href="index.html">Home</a>
  <select id="difficultySelect" aria-label="Difficulty">
    <option value="easy">Easy</option>
    <option value="medium" selected>Medium</option>
    <option value="hard">Hard</option>
  </select>
  <button class="btn-new" id="btnNew">New Problem</button>
  <button class="btn-guide header-btn active" id="btnGuide">Guide: On</button>
</div>

<div class="main">

  <!-- Galera -->
  <div class="galera-section">
    <div class="galera">
      <div class="galera-row" style="margin-bottom:8px;">
        <div class="galera-label"></div>
        <div class="galera-col-header">H</div>
        <div class="galera-col-header">T</div>
        <div class="galera-col-header">O</div>
      </div>
      <div class="galera-row carry-row">
        <div class="galera-label"></div>
        <div class="galera-carry-slot"><input class="galera-cell carry" id="carry-h" maxlength="1" inputmode="numeric" aria-label="Borrow hundreds"></div>
        <div class="galera-carry-slot"><input class="galera-cell carry" id="carry-t" maxlength="1" inputmode="numeric" aria-label="Borrow tens"></div>
        <div class="galera-carry-slot"><input class="galera-cell carry" id="carry-o" maxlength="1" inputmode="numeric" aria-label="Borrow ones"></div>
      </div>
      <div class="galera-row">
        <div class="galera-label"></div>
        <div class="galera-cell-wrap"><input class="galera-cell" id="g-a1-h" maxlength="1" inputmode="numeric" aria-label="Minuend hundreds"></div>
        <div class="galera-cell-wrap"><input class="galera-cell" id="g-a1-t" maxlength="1" inputmode="numeric" aria-label="Minuend tens"></div>
        <div class="galera-cell-wrap"><input class="galera-cell" id="g-a1-o" maxlength="1" inputmode="numeric" aria-label="Minuend ones"></div>
      </div>
      <div class="galera-row divider">
        <div class="galera-label">&minus;</div>
        <input class="galera-cell" id="g-a2-h" maxlength="1" inputmode="numeric" aria-label="Subtrahend hundreds">
        <input class="galera-cell" id="g-a2-t" maxlength="1" inputmode="numeric" aria-label="Subtrahend tens">
        <input class="galera-cell" id="g-a2-o" maxlength="1" inputmode="numeric" aria-label="Subtrahend ones">
      </div>
      <div class="galera-row">
        <div class="galera-label">=</div>
        <input class="galera-cell" id="g-r-h" maxlength="1" inputmode="numeric" aria-label="Result hundreds">
        <input class="galera-cell" id="g-r-t" maxlength="1" inputmode="numeric" aria-label="Result tens">
        <input class="galera-cell" id="g-r-o" maxlength="1" inputmode="numeric" aria-label="Result ones">
      </div>
    </div>
    <div class="guide-prompt" id="guidePrompt">
      <span id="guideText"></span>
      <input type="text" id="guideInput" inputmode="numeric" autocomplete="off">
      <button id="guideBorrowBtn" class="guide-borrow-btn">Borrow</button>
    </div>
    <div class="narration-bar" id="narrationBar">
      <div class="narration-icon" id="narrationIcon">&#x1F9D1;&#x200D;&#x1F3EB;</div>
      <div class="narration-text" id="narrationText"></div>
    </div>
    <div class="galera-buttons">
      <button class="btn-clear" id="btnClear">Clear</button>
      <button class="btn-check" id="btnCheck" disabled>Check Answer</button>
    </div>
  </div>

  <!-- Mat (collapsible) -->
  <div class="mat-section" id="matSection">
    <div class="mat-toggle" id="matToggle">
      <span class="arrow">&#9660;</span> Need help? Use Visual Blocks
    </div>
    <div class="mat-body">
      <div class="mat" id="theMat">
        <div class="mat-header">Hundreds<small>(100)</small></div>
        <div class="mat-header">Tens<small>(10)</small></div>
        <div class="mat-header">Ones<small>(1)</small></div>

        <div class="mat-cell hundreds-col row-minuend" id="mat-a1-h"><span class="mat-row-label">Minuend</span></div>
        <div class="mat-cell tens-col row-minuend" id="mat-a1-t"></div>
        <div class="mat-cell ones-col row-minuend" id="mat-a1-o"></div>

        <div class="mat-cell hundreds-col row-subtrahend" id="mat-a2-h"><span class="mat-row-label">Subtrahend</span></div>
        <div class="mat-cell tens-col row-subtrahend" id="mat-a2-t"></div>
        <div class="mat-cell ones-col row-subtrahend" id="mat-a2-o"></div>

        <div class="mat-cell hundreds-col row-result" id="mat-r-h"><span class="mat-row-label">Result</span></div>
        <div class="mat-cell tens-col row-result" id="mat-r-t"></div>
        <div class="mat-cell ones-col row-result" id="mat-r-o"></div>
      </div>
      <div class="count-bar" id="countBar">
        <div class="count-cell" id="count-h">Flats<span class="count-num">0</span></div>
        <div class="count-cell" id="count-t">Rods<span class="count-num">0</span></div>
        <div class="count-cell" id="count-o">Units<span class="count-num">0</span></div>
        <div class="count-total">Counted: <span class="count-formed" id="countFormed">0</span></div>
      </div>
      <div class="mat-actions-wrap">
        <button class="btn btn-subtract" id="btnSubtract" disabled>Take Away</button>
        <button class="btn btn-borrow" id="btnBorrow">Borrow!</button>
      </div>
    </div>
  </div>

</div>

<div class="feedback-overlay" id="feedbackOverlay"></div>

<script>
// ═══════════════════════════════════════════
// State
// ═══════════════════════════════════════════
const state = {
  difficulty: 'medium',
  num1: 0, // minuend
  num2: 0, // subtrahend
  phase: 'input',
  // phase: input | borrowed | borrowing-ones | borrowing-tens | ready | subtracting | mat-done
  borrows: { tens: 0, hundreds: 0 },
  animating: false,
  answered: false,
  matCollapsed: true,
  // Modified minuend digits after borrowing
  minuendMod: { ones: 0, tens: 0, hundreds: 0 },
  guide: 'ones', // null | 'ones' | 'tens' | 'hundreds' | 'done'
  guideEnabled: true, // whether guide mode is on
  guideBorrowsPending: null, // borrows array waiting for student to click Borrow
};

function setState(u) { Object.assign(state, u); render(); }


// ═══════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════
function digits(n) {
  return { hundreds: Math.floor(n/100), tens: Math.floor((n%100)/10), ones: n%10 };
}
function digitDisplay(d) {
  return {
    hundreds: d.hundreds || '',
    tens:  d.hundreds ? String(d.tens) : (d.tens || ''),
    ones: (d.hundreds || d.tens) ? String(d.ones) : (d.ones || ''),
  };
}
function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

// ═══════════════════════════════════════════
// Narration & Audio
// ═══════════════════════════════════════════
function setNarration(text) {
  const bar = document.getElementById('narrationBar');
  const textEl = document.getElementById('narrationText');
  textEl.style.opacity = '0';
  bar.classList.add('visible');
  setTimeout(() => { textEl.textContent = text; textEl.style.opacity = '1'; }, 200);
}
function clearNarration() {
  const bar = document.getElementById('narrationBar');
  const textEl = document.getElementById('narrationText');
  textEl.style.opacity = '0';
  setTimeout(() => { textEl.textContent = ''; bar.classList.remove('visible'); }, 300);
}

// ═══════════════════════════════════════════
// Movement Arrows
// ═══════════════════════════════════════════
function showMovementArrow(fromCellId, toCellId) {
  const matBody = document.querySelector('.mat-body');
  matBody.style.position = 'relative';
  const bodyRect = matBody.getBoundingClientRect();
  const fromEl = document.getElementById(fromCellId);
  const toEl = document.getElementById(toCellId);
  const fromRect = fromEl.getBoundingClientRect();
  const toRect = toEl.getBoundingClientRect();

  const x1 = fromRect.left + fromRect.width / 2 - bodyRect.left;
  const y1 = fromRect.top + fromRect.height / 4 - bodyRect.top;
  const x2 = toRect.left + toRect.width / 2 - bodyRect.left;
  const y2 = toRect.top + toRect.height / 4 - bodyRect.top;

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('movement-arrow');
  svg.setAttribute('width', bodyRect.width);
  svg.setAttribute('height', bodyRect.height);

  const markerId = 'ah-' + Date.now();
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  marker.setAttribute('id', markerId);
  marker.setAttribute('markerWidth', '10'); marker.setAttribute('markerHeight', '7');
  marker.setAttribute('refX', '10'); marker.setAttribute('refY', '3.5');
  marker.setAttribute('orient', 'auto');
  const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  poly.setAttribute('points', '0 0, 10 3.5, 0 7');
  poly.setAttribute('fill', '#E8573A');
  marker.appendChild(poly); defs.appendChild(marker); svg.appendChild(defs);

  const midX = (x1 + x2) / 2;
  const midY = Math.min(y1, y2) - 30;
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M${x1},${y1} Q${midX},${midY} ${x2},${y2}`);
  path.setAttribute('stroke', '#E8573A');
  path.setAttribute('stroke-width', '3');
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke-dasharray', '8 4');
  path.setAttribute('marker-end', `url(#${markerId})`);
  svg.appendChild(path);

  matBody.appendChild(svg);
  return svg;
}
function removeMovementArrows() {
  document.querySelectorAll('.movement-arrow').forEach(el => el.remove());
}

// ═══════════════════════════════════════════
// Galera Borrow Animation
// ═══════════════════════════════════════════
function addStrikeThrough(cellId) {
  const el = document.getElementById(cellId);
  const wrap = el.closest('.galera-cell-wrap');
  const line = document.createElement('div');
  line.className = 'galera-strike';
  line.style.position = 'absolute';
  line.style.top = '50%';
  line.style.left = '10%';
  line.style.width = '0';
  line.style.height = '3px';
  line.style.background = 'var(--color-accent)';
  line.style.borderRadius = '2px';
  line.style.transform = 'translateY(-50%) rotate(-15deg)';
  wrap.appendChild(line);
  void line.offsetWidth;
  line.style.width = '80%';
  return line;
}
function clearGaleraStrikes() {
  document.querySelectorAll('.galera-strike').forEach(el => el.remove());
}
function animateBorrowInGalera(srcMinuendId, srcCarryId, destCarryId, newSrcDigit) {
  return new Promise(resolve => {
    // Strike through the source minuend digit
    addStrikeThrough(srcMinuendId);

    // Show decreased value in carry cell above source
    setTimeout(() => {
      const srcCarry = document.getElementById(srcCarryId);
      srcCarry.value = String(newSrcDigit);
      srcCarry.classList.add('carry-bounce');
      setTimeout(() => srcCarry.classList.remove('carry-bounce'), 500);
    }, 400);

    // Fly a "1" from source to dest carry cell
    setTimeout(() => {
      const srcEl = document.getElementById(srcMinuendId);
      const destCarry = document.getElementById(destCarryId);
      const srcRect = srcEl.getBoundingClientRect();
      const destRect = destCarry.getBoundingClientRect();

      const floater = document.createElement('div');
      floater.className = 'floating-digit';
      floater.textContent = '1';
      floater.style.left = (srcRect.left + srcRect.width / 2 - 10) + 'px';
      floater.style.top = (srcRect.top - 15) + 'px';
      document.body.appendChild(floater);

      void floater.offsetWidth;
      floater.style.left = (destRect.left + destRect.width / 2 - 10) + 'px';
      floater.style.top = (destRect.top + destRect.height / 2 - 12) + 'px';
      floater.style.fontSize = '1.1rem';

      floater.addEventListener('transitionend', () => {
        floater.remove();
        destCarry.value = '1';
        destCarry.classList.add('carry-bounce');
        setTimeout(() => destCarry.classList.remove('carry-bounce'), 500);
        resolve();
      }, { once: true });
    }, 800);
  });
}
function animateGuideBorrowInGalera(srcMinuendId, srcCarryId, destMinuendId, newSrcDigit) {
  return new Promise(resolve => {
    addStrikeThrough(srcMinuendId);
    setTimeout(() => {
      const srcCarry = document.getElementById(srcCarryId);
      srcCarry.value = String(newSrcDigit);
      srcCarry.classList.add('carry-bounce');
      setTimeout(() => srcCarry.classList.remove('carry-bounce'), 500);
    }, 400);
    setTimeout(() => {
      const srcEl = document.getElementById(srcMinuendId);
      const destEl = document.getElementById(destMinuendId);
      const srcRect = srcEl.getBoundingClientRect();
      const destRect = destEl.getBoundingClientRect();
      const floater = document.createElement('div');
      floater.className = 'floating-digit';
      floater.textContent = '1';
      floater.style.left = (srcRect.left + srcRect.width / 2 - 10) + 'px';
      floater.style.top = (srcRect.top - 15) + 'px';
      document.body.appendChild(floater);
      void floater.offsetWidth;
      floater.style.left = (destRect.left + 6) + 'px';
      floater.style.top = (destRect.top + 4) + 'px';
      floater.style.fontSize = '0.85rem';
      floater.addEventListener('transitionend', () => {
        floater.remove();
        const wrap = destEl.closest('.galera-cell-wrap');
        if (wrap) {
          const indicator = document.createElement('span');
          indicator.className = 'borrow-indicator';
          indicator.textContent = '1';
          wrap.appendChild(indicator);
        }
        resolve();
      }, { once: true });
    }, 800);
  });
}

// ═══════════════════════════════════════════
// Blocks
// ═══════════════════════════════════════════
function createBlocks(count, type) {
  const f = document.createDocumentFragment();
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = `block ${type} entrance`;
    el.style.animationDelay = `${i * 0.04}s`;
    f.appendChild(el);
  }
  return f;
}
function clearCell(id) {
  const c = document.getElementById(id);
  const l = c.querySelector('.mat-row-label');
  c.innerHTML = '';
  if (l) c.appendChild(l);
}
function fillCell(id, count, type) {
  clearCell(id);
  document.getElementById(id).appendChild(createBlocks(count, type));
}
function renderMatInput() {
  const d1 = digits(state.num1), d2 = digits(state.num2);
  fillCell('mat-a1-h', d1.hundreds, 'flat');
  fillCell('mat-a1-t', d1.tens, 'rod');
  fillCell('mat-a1-o', d1.ones, 'unit');
  fillCell('mat-a2-h', d2.hundreds, 'flat');
  fillCell('mat-a2-t', d2.tens, 'rod');
  fillCell('mat-a2-o', d2.ones, 'unit');
  clearCell('mat-r-h'); clearCell('mat-r-t'); clearCell('mat-r-o');
  state.minuendMod = { ...d1 };
  updateCountBar();
}

// ═══════════════════════════════════════════
// Count Bar
// ═══════════════════════════════════════════
function updateCountBar() {
  const mat = document.getElementById('theMat');
  const flats = mat.querySelectorAll('.block.flat.counted').length;
  const rods  = mat.querySelectorAll('.block.rod.counted').length;
  const units = mat.querySelectorAll('.block.unit.counted').length;

  document.querySelector('#count-h .count-num').textContent = flats;
  document.querySelector('#count-t .count-num').textContent = rods;
  document.querySelector('#count-o .count-num').textContent = units;

  const total = flats * 100 + rods * 10 + units;
  document.getElementById('countFormed').textContent = total;
}

// ═══════════════════════════════════════════
// Galera refs
// ═══════════════════════════════════════════
const G = {
  a1h: document.getElementById('g-a1-h'),
  a1t: document.getElementById('g-a1-t'),
  a1o: document.getElementById('g-a1-o'),
  a2h: document.getElementById('g-a2-h'),
  a2t: document.getElementById('g-a2-t'),
  a2o: document.getElementById('g-a2-o'),
  rh:  document.getElementById('g-r-h'),
  rt:  document.getElementById('g-r-t'),
  ro:  document.getElementById('g-r-o'),
  ch:  document.getElementById('carry-h'),
  ct:  document.getElementById('carry-t'),
  co:  document.getElementById('carry-o'),
};

function setGaleraValues() {
  const d1 = digitDisplay(digits(state.num1));
  const d2 = digitDisplay(digits(state.num2));
  G.a1h.value = d1.hundreds; G.a1t.value = d1.tens; G.a1o.value = d1.ones;
  G.a2h.value = d2.hundreds; G.a2t.value = d2.tens; G.a2o.value = d2.ones;
}
function clearBorrowIndicators() {
  document.querySelectorAll('.borrow-indicator').forEach(el => el.remove());
}
function clearGaleraResults() {
  G.rh.value=''; G.rt.value=''; G.ro.value='';
  G.ch.value=''; G.ct.value=''; G.co.value='';
  ['rh','rt','ro'].forEach(k => G[k].classList.remove('correct','incorrect'));
  clearBorrowIndicators();
}
function lockInputs(keys, lock) {
  keys.forEach(k => { G[k].readOnly = lock; G[k].classList.toggle('readonly', lock); });
}

// ═══════════════════════════════════════════
// Borrow phase logic
// ═══════════════════════════════════════════
function determineBorrowPhase(minMod, sub) {
  // Check ones first
  if (minMod.ones < sub.ones) {
    // Need to borrow into ones — but from where?
    if (minMod.tens > 0) return 'borrowing-ones';
    if (minMod.hundreds > 0) return 'borrowing-tens'; // cascade: borrow into tens first
  }
  // Check tens
  if (minMod.tens < sub.tens) {
    if (minMod.hundreds > 0) return 'borrowing-tens';
  }
  return 'ready';
}

// ═══════════════════════════════════════════
// Render
// ═══════════════════════════════════════════
function render() {
  const btnSubtract = document.getElementById('btnSubtract');
  const btnBorrow   = document.getElementById('btnBorrow');
  const btnCheck    = document.getElementById('btnCheck');
  const hasNumbers  = state.num1 > 0 && state.num2 > 0;
  const isValid     = hasNumbers && state.num1 >= state.num2;

  // Take Away button: enabled in 'input' phase (will compute borrow needs) or 'ready' phase
  btnSubtract.disabled = !isValid || state.animating ||
    (state.phase !== 'input' && state.phase !== 'ready');

  const needsBorrow = state.phase === 'borrowing-ones' || state.phase === 'borrowing-tens';
  btnBorrow.classList.toggle('show', needsBorrow && !state.animating);

  lockInputs(['a1h','a1t','a1o','a2h','a2t','a2o'], state.animating);
  lockInputs(['rh','rt','ro'], !hasNumbers);
  btnCheck.disabled = !hasNumbers || state.animating;

  // Borrow cell highlighting
  const onesCell = document.getElementById('mat-a1-o');
  const tensCell = document.getElementById('mat-a1-t');

  onesCell.classList.toggle('needs-borrow', state.phase === 'borrowing-ones');
  tensCell.classList.toggle('needs-borrow', state.phase === 'borrowing-tens');

  // Borrow badges
  onesCell.querySelector('.borrow-badge')?.remove();
  tensCell.querySelector('.borrow-badge')?.remove();
  if (state.phase === 'borrowing-ones' && !state.animating) {
    const b = document.createElement('span');
    b.className = 'borrow-badge';
    b.textContent = 'Need more!';
    onesCell.appendChild(b);
  }
  if (state.phase === 'borrowing-tens' && !state.animating) {
    const b = document.createElement('span');
    b.className = 'borrow-badge';
    b.textContent = 'Need more!';
    tensCell.appendChild(b);
  }

  // Collapse state
  document.getElementById('matSection').classList.toggle('collapsed', state.matCollapsed);

  // Guide rendering
  const guideEl = document.getElementById('guidePrompt');
  const guideTextEl = document.getElementById('guideText');
  const guideInput = document.getElementById('guideInput');
  const borrowBtn = document.getElementById('guideBorrowBtn');
  const btnGuide = document.getElementById('btnGuide');
  ['ro','rt','rh'].forEach(k => G[k].classList.remove('guide-active'));
  if (state.guide && state.guide !== 'done') {
    guideTextEl.textContent = getGuidePrompt();
    guideEl.classList.add('show');
    btnGuide.classList.add('active');
    btnGuide.textContent = 'Guide: On';
    const key = state.guide === 'ones' ? 'ro' : state.guide === 'tens' ? 'rt' : 'rh';
    G[key].classList.add('guide-active');
    // Lock result + carry cells during guide mode
    lockInputs(['rh','rt','ro'], true);
    lockInputs(['ch','ct','co'], true);
    // Toggle borrow button vs guide input
    const hasPendingBorrows = state.guideBorrowsPending && state.guideBorrowsPending.length > 0;
    guideInput.style.display = hasPendingBorrows ? 'none' : '';
    borrowBtn.style.display = hasPendingBorrows ? 'inline-block' : 'none';
  } else {
    guideEl.classList.remove('show');
    borrowBtn.style.display = 'none';
    btnGuide.classList.toggle('active', state.guideEnabled);
    btnGuide.textContent = state.guideEnabled ? 'Guide: On' : 'Guide: Off';
    // Unlock carry cells when guide is off
    if (!state.guideEnabled || state.guide === 'done') {
      lockInputs(['ch','ct','co'], false);
    }
  }
}

// ═══════════════════════════════════════════
// Problem Generator
// ═══════════════════════════════════════════
function randInt(a,b) { return Math.floor(Math.random()*(b-a+1))+a; }
function needsBorrowCheck(a,b) {
  const da=digits(a), db=digits(b);
  return da.ones < db.ones || da.tens < db.tens;
}
function borrowCount(a,b) {
  const da=digits(a), db=digits(b);
  let c=0, bo=0;
  if (da.ones < db.ones) { c++; bo=1; }
  if (da.tens - bo < db.tens) { c++; }
  return c;
}
function generateProblem() {
  const d=state.difficulty; let a,b;
  if (d==='easy') {
    do { a=randInt(2,99); b=randInt(1,a-1); } while(needsBorrowCheck(a,b));
  } else if (d==='medium') {
    do { a=randInt(20,499); b=randInt(1,a-1); } while(borrowCount(a,b)>1 || !needsBorrowCheck(a,b));
  } else {
    do { a=randInt(100,999); b=randInt(10,a-1); } while(borrowCount(a,b)<1);
  }
  return {a,b};
}

function readGaleraValues() {
  return {
    num1: (parseInt(G.a1h.value)||0)*100 + (parseInt(G.a1t.value)||0)*10 + (parseInt(G.a1o.value)||0),
    num2: (parseInt(G.a2h.value)||0)*100 + (parseInt(G.a2t.value)||0)*10 + (parseInt(G.a2o.value)||0),
  };
}

// ═══════════════════════════════════════════
// Animation helpers
// ═══════════════════════════════════════════
function cleanAnimClasses(el) {
  el.classList.remove('entrance','slide-down','highlight','shrink-away','pop-in');
}
function animateElement(el, cls) {
  return new Promise(resolve => {
    cleanAnimClasses(el);
    void el.offsetWidth;
    el.classList.add(cls);
    el.addEventListener('animationend', () => resolve(), { once: true });
  });
}

// ═══════════════════════════════════════════
// Take Away (like Combine in addition, but removes)
// ═══════════════════════════════════════════
async function doTakeAway() {
  if (state.animating) return;

  // First check if borrowing is needed
  const d1 = digits(state.num1), d2 = digits(state.num2);
  if (state.phase === 'input') {
    state.minuendMod = { ...d1 };
    const bp = determineBorrowPhase(state.minuendMod, d2);
    if (bp !== 'ready') {
      setState({ phase: bp });
      return;
    }
  }

  setState({ animating: true });
  setNarration("Let's take away the blocks!");

  const sub = digits(state.num2);
  const mm = state.minuendMod;

  // Highlight blocks to remove in minuend row, per column
  async function removeFromColumn(cellId, selector, count) {
    if (count === 0) return;
    const cell = document.getElementById(cellId);
    const blocks = Array.from(cell.querySelectorAll(selector));
    const toRemove = blocks.slice(0, count);
    // Highlight
    toRemove.forEach(b => { cleanAnimClasses(b); void b.offsetWidth; b.classList.add('highlight'); });
    await wait(600);
    // Shrink away
    const p = toRemove.map(b => animateElement(b, 'shrink-away'));
    await Promise.all(p);
    toRemove.forEach(b => b.remove());
  }

  await removeFromColumn('mat-a1-o', '.block.unit', sub.ones);
  await removeFromColumn('mat-a1-t', '.block.rod', sub.tens);
  await removeFromColumn('mat-a1-h', '.block.flat', sub.hundreds);

  await wait(300);
  setNarration("Now let's see what's left!");

  // Move remaining blocks to result row
  const resultOnes = mm.ones - sub.ones;
  const resultTens = mm.tens - sub.tens;
  const resultHundreds = mm.hundreds - sub.hundreds;

  // Clear subtrahend row
  clearCell('mat-a2-h'); clearCell('mat-a2-t'); clearCell('mat-a2-o');

  // Move remaining from minuend to result
  clearCell('mat-a1-h'); clearCell('mat-a1-t'); clearCell('mat-a1-o');
  fillCell('mat-r-h', resultHundreds, 'flat');
  fillCell('mat-r-t', resultTens, 'rod');
  fillCell('mat-r-o', resultOnes, 'unit');

  // Animate result blocks sliding down
  document.querySelectorAll('.row-result .block').forEach((b, i) => {
    cleanAnimClasses(b); b.classList.add('slide-down');
    b.style.animationDelay = `${i * 0.03}s`;
  });

  await wait(1200);
  clearNarration();
  updateCountBar();
  setState({ phase: 'mat-done', animating: false });
}

// ═══════════════════════════════════════════
// Borrow — decompose block from next column
// ═══════════════════════════════════════════
async function doBorrow() {
  if (state.animating) return;
  setState({ animating: true });

  const sub = digits(state.num2);

  if (state.phase === 'borrowing-tens') {
    await borrowColumn('mat-a1-h', '.block.flat', 'mat-a1-t', 'rod', 10,
      () => { state.minuendMod.hundreds -= 1; state.minuendMod.tens += 10; state.borrows.hundreds = 1; },
      { need: sub.tens, have: state.minuendMod.tens,
        srcColName: 'hundreds', destColName: 'tens',
        conversion: '1 hundred = 10 tens!',
        newTotal: state.minuendMod.tens + 10, needVal: sub.tens,
        srcMinuendCell: 'g-a1-h', srcCarryCell: 'carry-h', destCarryCell: 'carry-t',
        newSrcDigit: state.minuendMod.hundreds - 1 }
    );
    const nextPhase = determineBorrowPhase(state.minuendMod, sub);
    setState({ phase: nextPhase, animating: false });
  } else if (state.phase === 'borrowing-ones') {
    await borrowColumn('mat-a1-t', '.block.rod', 'mat-a1-o', 'unit', 10,
      () => { state.minuendMod.tens -= 1; state.minuendMod.ones += 10; state.borrows.tens = 1; },
      { need: sub.ones, have: state.minuendMod.ones,
        srcColName: 'tens', destColName: 'ones',
        conversion: '1 ten = 10 ones!',
        newTotal: state.minuendMod.ones + 10, needVal: sub.ones,
        srcMinuendCell: 'g-a1-t', srcCarryCell: 'carry-t', destCarryCell: 'carry-o',
        newSrcDigit: state.minuendMod.tens - 1 }
    );
    const nextPhase = determineBorrowPhase(state.minuendMod, sub);
    setState({ phase: nextPhase, animating: false });
  }
}

async function borrowColumn(srcId, srcSel, destId, newType, count, updateFn, narr) {
  const src = document.getElementById(srcId);
  const blocks = Array.from(src.querySelectorAll(srcSel));
  if (blocks.length === 0) return;

  // Step 1: "Not enough!" narration
  setNarration(`We need ${narr.need} ${narr.destColName} but only have ${narr.have}. Not enough!`);

  await wait(2500);

  // Step 2: "Let's borrow"
  setNarration(`Let's borrow from the ${narr.srcColName} column.`);
  await wait(1500);

  // Step 3: Highlight the block being decomposed
  const block = blocks[blocks.length - 1];
  cleanAnimClasses(block); void block.offsetWidth;
  block.classList.add('highlight');
  await wait(800);

  // Step 4: Conversion narration + arrow
  setNarration(narr.conversion);
  const arrow = showMovementArrow(srcId, destId);

  await wait(1500);

  // Step 5: Shrink away the block
  await animateElement(block, 'shrink-away');
  block.remove();
  await wait(300);

  // Step 6: Pop in new blocks
  const dest = document.getElementById(destId);
  for (let i = 0; i < count; i++) {
    const nb = document.createElement('div');
    nb.className = `block ${newType} pop-in`;
    nb.style.animationDelay = `${i * 0.04}s`;
    dest.appendChild(nb);
  }

  updateFn();
  await wait(600);

  // Step 6.5: Galera borrow animation (strike-through + flying digit)
  await animateBorrowInGalera(narr.srcMinuendCell, narr.srcCarryCell, narr.destCarryCell, narr.newSrcDigit);
  await wait(400);

  // Step 7: Remove arrow
  arrow.remove();

  // Step 8: "Now we have enough!" narration
  setNarration(`Now we have ${narr.newTotal} ${narr.destColName}! That's enough to take away ${narr.needVal}.`);

  await wait(2500);

  // Step 9: Clear narration
  clearNarration();
  await wait(300);

  updateCountBar();
}

// ═══════════════════════════════════════════
// Check Answer
// ═══════════════════════════════════════════
function checkAnswer() {
  ['rh','rt','ro'].forEach(k => G[k].classList.remove('correct','incorrect'));
  const diff = state.num1 - state.num2;
  const cd = digits(diff);
  const dd = digitDisplay(cd);
  const uh = G.rh.value, ut = G.rt.value, uo = G.ro.value;
  let ok = true;
  [['rh', uh, dd.hundreds],['rt', ut, dd.tens],['ro', uo, dd.ones]].forEach(([k,u,c]) => {
    const uNum = parseInt(u) || 0;
    const cNum = parseInt(c) || 0;
    if (uNum === cNum) G[k].classList.add('correct');
    else { G[k].classList.add('incorrect'); ok = false; }
  });
  if (ok) { celebrate(); setState({ answered: true }); }
  else showHint();
}

// ═══════════════════════════════════════════
// Celebration / Hint / Audio
// ═══════════════════════════════════════════
function celebrate() {
  showConfetti();
  const ov = document.getElementById('feedbackOverlay');
  ov.innerHTML = '<div class="feedback-message">Great job!</div>';
  ov.classList.add('show');
  setTimeout(() => { ov.classList.remove('show'); ov.innerHTML = ''; clearConfetti(); }, 3000);
}
function showConfetti() {
  const colors = ['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#FF8C00','#7B68EE'];
  if (!document.getElementById('confetti-kf')) {
    const s = document.createElement('style'); s.id = 'confetti-kf';
    s.textContent = `@keyframes confettiFall{0%{transform:translateY(0) translateX(0) rotate(0);opacity:1}100%{transform:translateY(100vh) translateX(var(--drift)) rotate(var(--rot));opacity:0}}`;
    document.head.appendChild(s);
  }
  for (let i = 0; i < 30; i++) {
    const p = document.createElement('div'); p.className = 'confetti-piece';
    p.style.left = Math.random()*100+'vw';
    p.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
    p.style.width = (Math.random()*8+6)+'px'; p.style.height = (Math.random()*8+6)+'px';
    p.style.borderRadius = Math.random()>0.5 ? '50%' : '2px';
    p.style.setProperty('--drift', (Math.random()*200-100).toFixed(0)+'px');
    p.style.setProperty('--rot', (Math.random()*720).toFixed(0)+'deg');
    p.style.animation = `confettiFall ${(Math.random()*2+1.5).toFixed(2)}s ${(Math.random()*0.5).toFixed(2)}s ease-in forwards`;
    document.body.appendChild(p);
  }
}
function clearConfetti() { document.querySelectorAll('.confetti-piece').forEach(e => e.remove()); }
function showHint() {

  document.querySelectorAll('.hint-toast').forEach(e => e.remove());
  const t = document.createElement('div'); t.className = 'hint-toast';
  t.textContent = 'Count the remaining blocks in each column and try again!';
  document.body.appendChild(t);
  setTimeout(() => { t.classList.add('fade-out'); t.addEventListener('animationend', () => t.remove(), { once: true }); }, 2500);
}
// ═══════════════════════════════════════════
// New Problem / Reset
// ═══════════════════════════════════════════
function resetToInput() {
  clearNarration(); removeMovementArrows(); clearGaleraStrikes();
  clearGaleraResults(); clearBorrowIndicators();
  state.phase = 'input';
  state.borrows = { tens: 0, hundreds: 0 };
  state.minuendMod = { ones: 0, tens: 0, hundreds: 0 };
  state.animating = false; state.answered = false;
  state.guideBorrowsPending = null;
  renderMatInput(); render();
}
function newProblem() {
  const {a, b} = generateProblem();
  clearNarration(); removeMovementArrows(); clearGaleraStrikes(); clearConfetti();
  document.getElementById('feedbackOverlay').classList.remove('show');
  document.querySelectorAll('.hint-toast').forEach(e => e.remove());
  state.num1 = a; state.num2 = b;
  resetToInput(); setGaleraValues();
  state.guide = state.guideEnabled ? 'ones' : null;
  state.guideBorrowsPending = null;
  if (state.guide) {
    const exp = getSubtractionSteps();
    if (exp.ones.borrows && exp.ones.borrows.length > 0) {
      state.guideBorrowsPending = exp.ones.borrows;
    }
  }
  render();
  if (state.guide && !state.guideBorrowsPending) {
    document.getElementById('guideInput').focus();
  }
}

// ═══════════════════════════════════════════
// Guide
// ═══════════════════════════════════════════
function getSubtractionSteps() {
  const d1=digits(state.num1), d2=digits(state.num2);
  let m={hundreds:d1.hundreds, tens:d1.tens, ones:d1.ones};
  let ob=false, tb=false;
  const onesBorrows = [];
  const tensBorrows = [];
  if (m.ones<d2.ones) {
    if (m.tens>0) {
      onesBorrows.push({src:'g-a1-t', srcCarry:'carry-t', destMinuend:'g-a1-o', newDigit:m.tens-1});
      m.tens--; m.ones+=10; ob=true;
    } else if (m.hundreds>0) {
      onesBorrows.push({src:'g-a1-h', srcCarry:'carry-h', destMinuend:'g-a1-t', newDigit:m.hundreds-1});
      onesBorrows.push({src:'g-a1-t', srcCarry:'carry-t', destMinuend:'g-a1-o', newDigit:9});
      m.hundreds--; m.tens+=9; m.ones+=10; ob=true; tb=true;
    }
  }
  if (m.tens<d2.tens) {
    if (m.hundreds>0) {
      tensBorrows.push({src:'g-a1-h', srcCarry:'carry-h', destMinuend:'g-a1-t', newDigit:m.hundreds-1});
      m.hundreds--; m.tens+=10; tb=true;
    }
  }
  return {
    ones: {a:m.ones, b:d2.ones, result:m.ones-d2.ones, borrowed:ob, orig:d1.ones, borrows:onesBorrows},
    tens: {a:m.tens, b:d2.tens, result:m.tens-d2.tens, borrowed:tb, orig:d1.tens, borrows:tensBorrows},
    hundreds: {a:m.hundreds, b:d2.hundreds, result:m.hundreds-d2.hundreds, borrows:[]},
    needsHundreds: d1.hundreds>0 || d2.hundreds>0,
  };
}
function getGuidePrompt() {
  if (!state.guide || state.guide==='done') return '';
  const exp=getSubtractionSteps(), info=exp[state.guide];
  const col=state.guide.charAt(0).toUpperCase()+state.guide.slice(1);
  if (state.guideBorrowsPending && state.guideBorrowsPending.length > 0) {
    return col+': '+info.orig+' < '+info.b+' — Need to borrow!';
  }
  return col+': '+info.a+' \u2212 '+info.b+' = ?';
}
async function animateGuideBorrows(borrows) {
  if (!borrows || borrows.length === 0) return;
  state.animating = true; render();
  for (const b of borrows) {
    // Clear any existing borrow indicator on source (for chain borrows)
    const srcWrap = document.getElementById(b.src)?.closest('.galera-cell-wrap');
    if (srcWrap) srcWrap.querySelector('.borrow-indicator')?.remove();
    await animateGuideBorrowInGalera(b.src, b.srcCarry, b.destMinuend, b.newDigit);
    await wait(400);
  }
  state.animating = false; render();
  document.getElementById('guideInput').focus();
}
async function checkGuideStep() {
  if (!state.guide || state.guide==='done' || state.animating) return;
  const guideInput = document.getElementById('guideInput');
  const exp=getSubtractionSteps(), step=state.guide, info=exp[step];
  const key = step==='ones'?'ro': step==='tens'?'rt':'rh';
  const val=guideInput.value;
  if (val==='') return;
  if (parseInt(val)===info.result) {
    guideInput.classList.remove('incorrect'); guideInput.classList.add('correct');
    state.animating = true; render();
    await wait(500);
    // Place result digit in galera
    G[key].value = String(info.result);
    G[key].classList.add('correct');
    guideInput.value = '';
    guideInput.classList.remove('correct','incorrect');
    state.animating = false;
    // Advance step
    let next;
    if (step==='ones') next='tens';
    else if (step==='tens') next=exp.needsHundreds?'hundreds':'done';
    else next='done';
    state.guide=next; render();
    if (next==='done') { celebrate(); state.answered=true; }
    else {
      // Set pending borrows for next step if needed
      const nextInfo = exp[next];
      if (nextInfo && nextInfo.borrows && nextInfo.borrows.length > 0) {
        state.guideBorrowsPending = nextInfo.borrows;
        render();
      } else {
        guideInput.focus();
      }
    }
  } else {
    guideInput.classList.remove('correct'); guideInput.classList.add('incorrect');
    showHint();
  }
}
function toggleGuide() {
  if (state.animating) return;
  state.guideEnabled = !state.guideEnabled;
  const guideInput = document.getElementById('guideInput');
  guideInput.value = '';
  guideInput.classList.remove('correct','incorrect');
  clearGaleraStrikes(); clearBorrowIndicators();
  state.guideBorrowsPending = null;
  if (!state.guideEnabled) {
    state.guide = null;
  } else if (state.num1>0 && state.num2>0 && state.num1>=state.num2 && !state.answered) {
    clearGaleraResults(); state.guide='ones'; state.answered=false;
    const exp = getSubtractionSteps();
    if (exp.ones.borrows && exp.ones.borrows.length > 0) {
      state.guideBorrowsPending = exp.ones.borrows;
    }
  }
  render();
  if (state.guide && !state.guideBorrowsPending) guideInput.focus();
}

// ═══════════════════════════════════════════
// Input Handling — Calculator-style entry
// ═══════════════════════════════════════════
state.entryTarget = 'a1'; // 'a1' or 'a2' — which operand is being entered

function shiftDigitLeft(prefix) {
  const h = G[prefix+'h'], t = G[prefix+'t'], o = G[prefix+'o'];
  h.value = t.value; t.value = o.value; o.value = '';
}
function shiftDigitRight(prefix) {
  const h = G[prefix+'h'], t = G[prefix+'t'], o = G[prefix+'o'];
  o.value = t.value; t.value = h.value; h.value = '';
}
function pushDigit(prefix, digit) {
  const h = G[prefix+'h'];
  if (h.value) return; // already 3 digits, ignore
  shiftDigitLeft(prefix);
  G[prefix+'o'].value = digit;
}
function popDigit(prefix) {
  const o = G[prefix+'o'];
  if (!o.value && !G[prefix+'t'].value && !G[prefix+'h'].value) return;
  o.value = '';
  shiftDigitRight(prefix);
}
function syncStateFromGalera() {
  const { num1, num2 } = readGaleraValues();
  state.num1 = num1; state.num2 = num2;
  if (state.phase !== 'input') {
    state.phase = 'input';
    state.borrows = { tens: 0, hundreds: 0 };
    state.minuendMod = { ones: 0, tens: 0, hundreds: 0 };
    clearGaleraResults();
  }
  state.answered = false;
  const guideInput = document.getElementById('guideInput');
  guideInput.value = '';
  guideInput.classList.remove('correct','incorrect');
  clearGaleraStrikes(); clearBorrowIndicators();
  state.guideBorrowsPending = null;
  if (state.guideEnabled) {
    state.guide = (state.num1>0 && state.num2>0 && state.num1>=state.num2) ? 'ones' : null;
    clearGaleraResults();
    if (state.guide) {
      const exp = getSubtractionSteps();
      if (exp.ones.borrows && exp.ones.borrows.length > 0) {
        state.guideBorrowsPending = exp.ones.borrows;
      }
    }
  }
  renderMatInput(); render();
}
function confirmAndJump(target) {
  state.entryTarget = target;
  G[target+'o'].focus();
}
function confirmBothAndStart() {
  syncStateFromGalera();
  if (state.num1>0 && state.num2>0 && state.num1>=state.num2) {
    if (state.guide && !state.guideBorrowsPending) document.getElementById('guideInput').focus();
    else if (!state.guide) G.ro.focus();
  }
}

// All addend cells: prevent stale input
const addendCells = ['a1h','a1t','a1o','a2h','a2t','a2o'];
addendCells.forEach(k => {
  G[k].addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g,'');
  });
});
// Keydown handler on addend cells
addendCells.forEach(k => {
  G[k].addEventListener('keydown', function(e) {
    const prefix = state.entryTarget;
    if (e.key >= '0' && e.key <= '9') {
      e.preventDefault();
      pushDigit(prefix, e.key);
      syncStateFromGalera();
      G[prefix+'o'].focus();
    } else if (e.key === 'Backspace') {
      e.preventDefault();
      popDigit(prefix);
      syncStateFromGalera();
      G[prefix+'o'].focus();
    } else if (e.key === 'Enter' || e.key === 'Tab' || e.key === '-') {
      e.preventDefault();
      if (prefix === 'a1') {
        syncStateFromGalera();
        confirmAndJump('a2');
      } else {
        confirmBothAndStart();
      }
    } else if (e.key === 'Escape') {
      e.preventDefault();
      this.blur();
    }
  });
});
// Click on any addend cell sets entryTarget to that operand
addendCells.forEach(k => {
  G[k].addEventListener('focus', function() {
    state.entryTarget = k.startsWith('a1') ? 'a1' : 'a2';
  });
});

['rh','rt','ro'].forEach(k => {
  G[k].addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 1);
    this.classList.remove('correct', 'incorrect');
  });
  G[k].addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const {num1,num2}=readGaleraValues();
      state.num1=num1; state.num2=num2;
      if (state.num1>0 && state.num2>0) checkAnswer();
    }
  });
});
// Borrow inputs — editable, filter to digits
['ch','ct','co'].forEach(k => {
  G[k].addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 1);
  });
});
// Guide input handler
document.getElementById('guideInput').addEventListener('input', function(){
  this.value=this.value.replace(/[^0-9]/g,'').slice(0,2);
  this.classList.remove('correct','incorrect');
  if (this.value) checkGuideStep();
});
// Guide borrow button handler
document.getElementById('guideBorrowBtn').addEventListener('click', async () => {
  if (!state.guideBorrowsPending || state.guideBorrowsPending.length === 0 || state.animating) return;
  const borrows = state.guideBorrowsPending;
  state.guideBorrowsPending = null;
  await animateGuideBorrows(borrows);
});

// ═══════════════════════════════════════════
// Block counting
// ═══════════════════════════════════════════
document.getElementById('theMat').addEventListener('click', (e) => {
  const block = e.target.closest('.block');
  if (!block || state.animating) return;
  block.classList.toggle('counted');
  updateCountBar();
});

// ═══════════════════════════════════════════
// Collapse toggle
// ═══════════════════════════════════════════
document.getElementById('matToggle').addEventListener('click', () => {
  setState({ matCollapsed: !state.matCollapsed });
});

// ═══════════════════════════════════════════
// Event Listeners
// ═══════════════════════════════════════════
document.getElementById('btnClear').addEventListener('click', () => {
  clearConfetti();
  document.getElementById('feedbackOverlay').classList.remove('show');
  document.querySelectorAll('.hint-toast').forEach(e => e.remove());
  G.a1h.value=''; G.a1t.value=''; G.a1o.value='';
  G.a2h.value=''; G.a2t.value=''; G.a2o.value='';
  state.num1=0; state.num2=0;
  state.guide = state.guideEnabled ? 'ones' : null;
  state.entryTarget = 'a1';
  resetToInput(); render();
  G.a1o.focus();
});
document.getElementById('btnNew').addEventListener('click', newProblem);
document.getElementById('btnGuide').addEventListener('click', toggleGuide);
document.getElementById('btnSubtract').addEventListener('click', () => {
  if (state.num1 > 0 && state.num2 > 0 && state.num1 >= state.num2) doTakeAway();
});
document.getElementById('btnBorrow').addEventListener('click', doBorrow);
document.getElementById('btnCheck').addEventListener('click', () => {
  const { num1, num2 } = readGaleraValues();
  state.num1 = num1; state.num2 = num2;
  if (state.num1 > 0 && state.num2 > 0 && state.num1 >= state.num2) checkAnswer();
});
document.getElementById('difficultySelect').addEventListener('change', function() {
  state.difficulty = this.value;
});
// ═══════════════════════════════════════════
// Init
// ═══════════════════════════════════════════
newProblem();
</script>
</body>
</html>
