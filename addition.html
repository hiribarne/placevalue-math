<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Place Value Addition</title>
<style>
:root {
  --unit-size: 28px;
  --rod-width: 28px;
  --rod-height: 140px;
  --flat-size: 140px;
  --color-unit: #4A90D9;
  --color-rod: #7BC67E;
  --color-flat: #F5A623;
  --color-bg: #F7F3EE;
  --color-header: #5B4A8A;
  --color-accent: #E8573A;
  --color-success: #4CAF50;
  --color-text: #333;
  --color-light-text: #777;
  --color-border: #ccc;
  --color-mat-bg: #FAFAF5;
  --color-mat-header: #EDE8E0;
  --color-galera-bg: #fff;
  --radius: 4px;
  --shadow-block: 1px 2px 4px rgba(0,0,0,0.18);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--color-bg);
  color: var(--color-text);
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
  -webkit-text-size-adjust: 100%;
  overflow-x: hidden;
}

/* ── Header ── */
.header {
  background: var(--color-header);
  color: #fff;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}
.header h1 { font-size: 1.3rem; font-weight: 700; margin-right: auto; }
.header select, .header button {
  font-size: 0.95rem; padding: 8px 14px; border: none;
  border-radius: 6px; cursor: pointer; min-height: 44px;
}
.header select {
  background: rgba(255,255,255,0.2); color: #fff;
  appearance: none; -webkit-appearance: none; padding-right: 28px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='white' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
.header select option { color: #333; background: #fff; }
.btn-new { background: var(--color-accent); color: #fff; font-weight: 600; }
.btn-new:active { transform: scale(0.96); }
.btn-home {
  background: rgba(255,255,255,0.2); color: #fff; font-weight: 600;
  text-decoration: none; display: inline-flex; align-items: center; gap: 4px;
  font-size: 0.95rem; padding: 8px 14px; border-radius: 6px; min-height: 44px;
}
.btn-home:active { transform: scale(0.96); }
.problem-counter {
  font-size: 0.85rem; opacity: 0.8; font-weight: 600;
  margin-left: auto; white-space: nowrap;
}

/* ── Main Layout ── */
.main {
  display: flex; flex-direction: column; align-items: center;
  gap: 24px; padding: 20px;
  max-width: 700px; margin: 0 auto;
}

/* ── Galera Section ── */
.galera-section {
  display: flex; flex-direction: column; align-items: center; gap: 16px;
  width: 100%;
}
.galera {
  background: var(--color-galera-bg); border: 2px solid var(--color-border);
  border-radius: 14px; padding: 28px 32px; display: inline-block;
}
.galera-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.galera-row.carry-row { margin-bottom: 2px; }
.galera-row.divider {
  border-bottom: 3px solid var(--color-text); padding-bottom: 8px; margin-bottom: 8px;
}
.galera-label {
  width: 32px; text-align: center; font-size: 1.6rem;
  font-weight: 700; color: var(--color-light-text);
}
.galera-cell {
  width: 72px; height: 72px; border: 2px solid var(--color-border);
  border-radius: 8px; text-align: center; font-size: 2.2rem; font-weight: 700;
  font-family: 'Courier New', monospace; background: #fff;
  color: var(--color-text); outline: none;
  -webkit-appearance: none; appearance: none;
}
.galera-cell:focus {
  border-color: var(--color-header); box-shadow: 0 0 0 3px rgba(91,74,138,0.2);
}
.galera-cell.readonly { background: #f5f5f5; cursor: default; }
.galera-carry-slot { width: 72px; display: flex; justify-content: center; }
.galera-cell.carry {
  width: 44px; height: 44px; font-size: 1.3rem; font-weight: 700;
  border: 2px solid #d4b896; color: var(--color-accent); background: #FFF8F0;
}
.galera-cell.carry:focus {
  border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(232,87,58,0.15);
}
.galera-cell.correct { border-color: var(--color-success); background: #F0FFF0; }
.galera-cell.incorrect {
  border-color: var(--color-accent); background: #FFF0F0; animation: shake 0.4s ease;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-4px); }
  75% { transform: translateX(4px); }
}
.galera-col-header {
  text-align: center; font-size: 0.85rem; color: var(--color-light-text); width: 72px;
  font-weight: 600;
}

/* Check button */
.btn-check {
  background: var(--color-success); color: #fff; padding: 14px 36px;
  font-size: 1.15rem; font-weight: 700; border: none; border-radius: 10px;
  cursor: pointer; min-height: 48px; width: 100%; max-width: 280px;
  transition: transform 0.15s ease;
}
.btn-check:active { transform: scale(0.96); }
.btn-check:disabled { opacity: 0.4; cursor: not-allowed; }
.galera-buttons { display: flex; gap: 10px; width: 100%; max-width: 280px; }
.galera-buttons .btn-check { flex: 1; }
.btn-clear {
  background: #fff; color: var(--color-light-text); padding: 14px 16px;
  font-size: 1.15rem; font-weight: 700; border: 2px solid var(--color-border);
  border-radius: 10px; cursor: pointer; min-height: 48px;
  transition: transform 0.15s ease;
}
.btn-clear:active { transform: scale(0.96); }

/* Guide Me */
.btn-guide { background: #6C5CE7; color: #fff; font-weight: 600; }
.btn-guide:active { transform: scale(0.96); }
.btn-guide.active { background: #A29BFE; }
.guide-prompt {
  background: #6C5CE7; color: #fff; padding: 12px 20px; border-radius: 10px;
  font-size: 1.15rem; font-weight: 600; text-align: center;
  width: 100%; max-width: 380px; display: none; line-height: 1.4;
  align-items: center; gap: 10px; justify-content: center;
}
.guide-prompt.show { display: flex; }
#guideInput {
  width: 60px; height: 44px; text-align: center; font-size: 1.4rem;
  font-weight: 700; font-family: 'Courier New', monospace;
  border: 2px solid rgba(255,255,255,0.4); border-radius: 8px;
  background: #fff; color: var(--color-text); outline: none;
  -webkit-appearance: none; appearance: none; flex-shrink: 0;
}
#guideInput:focus {
  border-color: #fff; box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
}
#guideInput.correct { border-color: var(--color-success); background: #F0FFF0; }
#guideInput.incorrect {
  border-color: var(--color-accent); background: #FFF0F0; animation: shake 0.4s ease;
}
.galera-cell.guide-active {
  border-color: #6C5CE7 !important;
  box-shadow: 0 0 0 3px rgba(108,92,231,0.25) !important;
}
.entry-hint {
  font-size: 0.85rem; color: var(--color-light-text); text-align: center;
  margin-top: -8px; transition: opacity 0.3s ease;
}

/* ── Estimation Prompt ── */
.estimate-prompt {
  background: #FFF3CD; border: 2px solid #F0D78C; border-radius: 10px;
  padding: 12px 20px; width: 100%; max-width: 380px; text-align: center;
  display: none; font-size: 1rem; font-weight: 600; color: #856404;
  animation: toastIn 0.35s ease;
}
.estimate-prompt.show { display: flex; align-items: center; gap: 10px; justify-content: center; }
.estimate-prompt input {
  width: 80px; height: 40px; text-align: center; font-size: 1.2rem;
  font-weight: 700; font-family: 'Courier New', monospace;
  border: 2px solid #F0D78C; border-radius: 8px; background: #fff;
  color: var(--color-text); outline: none;
}
.estimate-prompt input:focus { border-color: #D4A017; box-shadow: 0 0 0 3px rgba(212,160,23,0.2); }
.estimate-prompt .estimate-result {
  font-size: 0.9rem; font-weight: 700; margin-left: 6px;
}
.estimate-prompt .estimate-result.close { color: var(--color-success); }
.estimate-prompt .estimate-result.far { color: var(--color-accent); }

/* ── Adaptive Difficulty Banner ── */
.difficulty-suggestion {
  position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
  background: #6C5CE7; color: #fff; padding: 12px 20px; border-radius: 10px;
  font-size: 0.95rem; font-weight: 600; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  z-index: 103; animation: toastIn 0.35s ease; display: flex; align-items: center; gap: 12px;
  max-width: 90vw; text-align: center;
}
.difficulty-suggestion button {
  background: #fff; color: #6C5CE7; border: none; padding: 6px 14px;
  border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.9rem; white-space: nowrap;
}
.difficulty-suggestion .dismiss-btn {
  background: transparent; color: rgba(255,255,255,0.7); padding: 4px 8px; font-size: 1.2rem;
}
.difficulty-suggestion.fade-out { animation: toastOut 0.3s ease forwards; }

/* ── Expanded Notation ── */
.expanded-section { display: flex; flex-direction: column; gap: 0; width: 100%; }
.expanded-toggle {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  background: #F0E6FF; border: 2px solid #C9B3E8;
  border-radius: 10px 10px 0 0; padding: 12px 16px; cursor: pointer;
  font-size: 0.9rem; font-weight: 700; color: var(--color-text);
  user-select: none; -webkit-user-select: none;
}
.expanded-toggle .arrow {
  display: inline-block; transition: transform 0.25s ease; font-size: 0.7rem;
}
.expanded-section.collapsed .expanded-toggle { border-radius: 10px; }
.expanded-section.collapsed .arrow { transform: rotate(-90deg); }
.expanded-body {
  overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease;
  max-height: 300px; opacity: 1; border: 2px solid #C9B3E8; border-top: none;
  border-radius: 0 0 10px 10px; background: #fff; padding: 16px 20px;
}
.expanded-section.collapsed .expanded-body { max-height: 0; opacity: 0; padding: 0 20px; }
.expanded-row {
  font-size: 1.1rem; font-weight: 600; line-height: 1.8; color: var(--color-text);
  font-family: 'Courier New', monospace;
}
.expanded-row .place-h { color: var(--color-flat); }
.expanded-row .place-t { color: var(--color-rod); }
.expanded-row .place-o { color: var(--color-unit); }

/* ── Number Line Section (collapsible) ── */
.numline-section { display: flex; flex-direction: column; gap: 0; width: 100%; }
.numline-toggle {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  background: #E8F4FD; border: 2px solid #B0D4F1;
  border-radius: 10px 10px 0 0; padding: 12px 16px; cursor: pointer;
  font-size: 0.9rem; font-weight: 700; color: var(--color-text);
  user-select: none; -webkit-user-select: none;
}
.numline-toggle .arrow {
  display: inline-block; transition: transform 0.25s ease; font-size: 0.7rem;
}
.numline-section.collapsed .numline-toggle { border-radius: 10px; }
.numline-section.collapsed .arrow { transform: rotate(-90deg); }
.numline-body {
  overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease;
  max-height: 500px; opacity: 1; border: 2px solid #B0D4F1; border-top: none;
  border-radius: 0 0 10px 10px; background: #fff; padding: 16px 12px;
}
.numline-section.collapsed .numline-body { max-height: 0; opacity: 0; padding: 0 12px; }
.numline-svg { width: 100%; height: 120px; }
.numline-svg text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

/* ── Mat Section (collapsible) ── */
.mat-section { display: flex; flex-direction: column; gap: 0; width: 100%; }
.mat-toggle {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  background: var(--color-mat-header); border: 2px solid #c4b89a;
  border-radius: 10px 10px 0 0; padding: 12px 16px; cursor: pointer;
  font-size: 0.9rem; font-weight: 700; color: var(--color-text);
  user-select: none; -webkit-user-select: none;
}
.mat-toggle .arrow {
  display: inline-block; transition: transform 0.25s ease; font-size: 0.7rem;
}
.mat-section.collapsed .mat-toggle { border-radius: 10px; }
.mat-section.collapsed .arrow { transform: rotate(-90deg); }
.mat-body {
  overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease;
  max-height: 2000px; opacity: 1;
}
.mat-section.collapsed .mat-body { max-height: 0; opacity: 0; }

.mat {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  border: 2px solid #c4b89a; border-top: none;
  overflow: hidden; background: var(--color-mat-bg);
}
.mat-header {
  background: var(--color-mat-header); padding: 6px 4px;
  text-align: center; font-weight: 700; font-size: 0.8rem;
  border-bottom: 2px solid #c4b89a;
}
.mat-header small { display: block; font-weight: 400; font-size: 0.7rem; color: var(--color-light-text); }
.mat-cell {
  border: 1px solid #e0dbd2; padding: 6px; min-height: 60px;
  display: flex; flex-wrap: wrap; align-content: flex-start;
  gap: 3px; position: relative;
}
.mat-cell.hundreds-col { background: rgba(245,166,35,0.05); }
.mat-cell.tens-col     { background: rgba(123,198,126,0.05); }
.mat-cell.ones-col     { background: rgba(74,144,217,0.05); }
.mat-row-label {
  position: absolute; top: 2px; left: 4px;
  font-size: 0.6rem; color: var(--color-light-text); pointer-events: none;
}
.mat-cell.row-addend2 { border-top: 2px solid #c4b89a; }
.mat-cell.row-result  { border-top: 3px solid #c4b89a; }

/* ── Counter bar ── */
.count-bar {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  border: 2px solid #c4b89a; border-top: 2px dashed #c4b89a;
  background: #f0ede6;
}
.count-cell {
  padding: 6px 4px; text-align: center; font-size: 0.8rem;
  font-weight: 700; color: var(--color-light-text);
  border-right: 1px solid #e0dbd2;
}
.count-cell:last-child { border-right: none; }
.count-cell .count-num {
  font-size: 1.2rem; color: var(--color-text); display: block; line-height: 1;
}
.count-total {
  grid-column: 1 / -1; text-align: center; padding: 5px 4px;
  font-size: 0.8rem; color: var(--color-light-text);
  border-top: 1px solid #d5d0c7;
}
.count-total .count-formed {
  font-size: 1.1rem; font-weight: 800; color: var(--color-header);
  margin-left: 4px; font-family: 'Courier New', monospace;
}

/* Mat actions + bottom border */
.mat-actions-wrap {
  border: 2px solid #c4b89a; border-top: none;
  border-radius: 0 0 10px 10px; background: var(--color-mat-bg);
  padding: 10px; display: flex; gap: 8px; justify-content: center;
}

/* ── Blocks ── */
.block {
  border-radius: var(--radius); box-shadow: var(--shadow-block);
  flex-shrink: 0; cursor: pointer; position: relative;
}
.block.unit {
  width: var(--unit-size); height: var(--unit-size);
  background: var(--color-unit); border: 1px solid #3a7bc0;
}
.block.rod {
  width: var(--rod-width); height: var(--rod-height);
  background: var(--color-rod); border: 1px solid #5ea862;
  background-image: repeating-linear-gradient(
    to bottom, transparent, transparent 13px,
    rgba(0,0,0,0.12) 13px, rgba(0,0,0,0.12) 14px
  );
}
.block.flat {
  width: var(--flat-size); height: var(--flat-size);
  background: var(--color-flat); border: 1px solid #d4901c;
  background-image:
    repeating-linear-gradient(to bottom, transparent, transparent 13px,
      rgba(0,0,0,0.10) 13px, rgba(0,0,0,0.10) 14px),
    repeating-linear-gradient(to right, transparent, transparent 13px,
      rgba(0,0,0,0.10) 13px, rgba(0,0,0,0.10) 14px);
}

/* Block counting */
.block.counted { opacity: 0.45; }
.block.counted::after {
  content: '\2713'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-weight: 900; font-size: 1em;
  text-shadow: 0 1px 3px rgba(0,0,0,0.6); pointer-events: none;
}
.block.unit.counted::after { font-size: 0.85em; }
.block.rod.counted::after  { font-size: 1.4em; }
.block.flat.counted::after { font-size: 3em; }

/* Block animations — ORDER MATTERS (later wins) */
.block.entrance { animation: blockEntrance 0.35s ease-out forwards; }
@keyframes blockEntrance {
  from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; }
}
.block.slide-down { animation: slideDown 0.5s ease forwards; }
@keyframes slideDown {
  from { transform: translateY(-40px); opacity: 0.5; } to { transform: translateY(0); opacity: 1; }
}
.block.highlight { animation: blockHighlight 0.6s ease infinite; }
@keyframes blockHighlight {
  0%, 100% { box-shadow: 0 0 0 0 rgba(232,87,58,0.4); }
  50%      { box-shadow: 0 0 0 6px rgba(232,87,58,0.15); }
}
.block.shrink-away { animation: shrinkAway 0.4s ease forwards; }
@keyframes shrinkAway { to { transform: scale(0); opacity: 0; } }
.block.pop-in { animation: popIn 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards; }
@keyframes popIn {
  from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; }
}

/* ── Mat buttons ── */
.btn {
  padding: 10px 20px; font-size: 1rem; font-weight: 700; border: none;
  border-radius: 8px; cursor: pointer; min-height: 44px;
  transition: transform 0.15s ease;
}
.btn:active { transform: scale(0.96); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
.btn-combine { background: var(--color-header); color: #fff; }
.btn-regroup { background: var(--color-accent); color: #fff; display: none; }
.btn-regroup.show {
  display: inline-block;
  animation: regroupBtnPulse 0.8s ease infinite;
}
@keyframes regroupBtnPulse {
  0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(232,87,58,0.6); }
  50%      { transform: scale(1.06); box-shadow: 0 0 0 12px rgba(232,87,58,0); }
}

/* ── REGROUP NEEDED — very noticeable ── */
.mat-cell.needs-regroup {
  animation: regroupFlash 0.7s ease infinite;
  border: 3px solid var(--color-accent);
  z-index: 1;
}
@keyframes regroupFlash {
  0%, 100% {
    background: rgba(232,87,58,0.08);
    box-shadow: inset 0 0 12px rgba(232,87,58,0.15), 0 0 0 0 rgba(232,87,58,0.3);
  }
  50% {
    background: rgba(232,87,58,0.22);
    box-shadow: inset 0 0 20px rgba(232,87,58,0.25), 0 0 0 8px rgba(232,87,58,0.08);
  }
}
.regroup-badge {
  position: absolute; top: -10px; right: -10px;
  background: var(--color-accent); color: #fff; font-size: 0.65rem; font-weight: 800;
  padding: 3px 6px; border-radius: 8px; white-space: nowrap;
  animation: badgeBounce 0.7s ease infinite; z-index: 2;
  pointer-events: none;
}
@keyframes badgeBounce {
  0%, 100% { transform: translateY(0); }
  50%      { transform: translateY(-4px); }
}

/* ── Feedback ── */
.feedback-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  display: none; align-items: flex-start; justify-content: center;
  padding-top: 18vh;
  z-index: 100; pointer-events: none;
}
.feedback-overlay.show { display: flex; }
.feedback-message {
  font-size: 2.2rem; font-weight: 800; color: #fff;
  background: var(--color-success); padding: 16px 40px; border-radius: 16px;
  box-shadow: 0 8px 32px rgba(76,175,80,0.4);
  pointer-events: none;
  animation: bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes bounceIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.hint-toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: #FFF3CD; color: #856404; padding: 14px 28px; border-radius: 10px;
  font-size: 1.1rem; font-weight: 600; box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  z-index: 100; animation: toastIn 0.35s ease; pointer-events: none;
  white-space: normal; max-width: 90vw; text-align: center;
}
@keyframes toastIn {
  from { transform: translateX(-50%) translateY(20px); opacity: 0; }
  to   { transform: translateX(-50%) translateY(0); opacity: 1; }
}
.hint-toast.fade-out { animation: toastOut 0.3s ease forwards; }
@keyframes toastOut { to { transform: translateX(-50%) translateY(20px); opacity: 0; } }

.undo-toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: #333; color: #fff; padding: 12px 20px; border-radius: 10px;
  font-size: 1rem; font-weight: 600; box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  z-index: 102; animation: toastIn 0.35s ease; display: flex; align-items: center; gap: 12px;
}
.undo-toast button {
  background: #fff; color: #333; border: none; padding: 6px 14px;
  border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.95rem;
}
.undo-toast.fade-out { animation: toastOut 0.3s ease forwards; }

.confetti-piece {
  position: fixed; top: -10px; width: 10px; height: 10px;
  border-radius: 2px; z-index: 101; pointer-events: none;
}

/* ── Responsive ── */
@media (max-width: 768px) {
  :root { --unit-size:22px; --rod-width:22px; --rod-height:110px; --flat-size:110px; }
  .header { padding: 10px 14px; gap: 8px; }
  .header h1 { font-size: 1.1rem; width: 100%; }
  .main { padding: 12px; gap: 16px; }
  .galera { padding: 20px; }
  .galera-cell { width: 60px; height: 60px; font-size: 1.9rem; }
  .galera-carry-slot { width: 60px; }
  .galera-cell.carry { width: 38px; height: 38px; font-size: 1.1rem; }
  .galera-col-header { width: 60px; }
  .galera-row { gap: 6px; }
  .galera-label { width: 28px; font-size: 1.4rem; }
}
@media (max-width: 480px) {
  :root { --unit-size:18px; --rod-width:18px; --rod-height:90px; --flat-size:90px; }
  .galera-cell { width: 50px; height: 50px; font-size: 1.5rem; }
  .galera-carry-slot { width: 50px; }
  .galera-cell.carry { width: 32px; height: 32px; font-size: 1rem; }
  .galera-col-header { width: 50px; }
  .galera-row { gap: 4px; }
  .galera-label { width: 24px; font-size: 1.3rem; }
  .btn { padding: 10px 16px; font-size: 0.95rem; }
  .btn-check { font-size: 1.05rem; padding: 12px 28px; }
}

/* ── Narration Bar ── */
.narration-bar {
  display: none; align-items: center; gap: 12px;
  background: linear-gradient(135deg, #6C5CE7, #a855f7);
  color: #fff; padding: 14px 20px; border-radius: 12px;
  width: 100%; max-width: 380px;
  box-shadow: 0 4px 12px rgba(108,92,231,0.3);
  min-height: 60px;
}
.narration-bar.visible { display: flex; }
.narration-icon {
  font-size: 1.8rem; flex-shrink: 0;
  animation: iconBob 2s ease-in-out infinite;
}
@keyframes iconBob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
.narration-text {
  flex: 1; font-size: 1.15rem; font-weight: 600;
  line-height: 1.3; transition: opacity 0.3s ease;
}
/* ── Movement Arrows ── */
.movement-arrow {
  position: absolute; top: 0; left: 0;
  pointer-events: none; z-index: 10; overflow: visible;
}
.movement-arrow path {
  animation: arrowFadeIn 0.4s ease forwards, arrowMarch 0.8s linear infinite;
}
@keyframes arrowFadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes arrowMarch { to { stroke-dashoffset: -24; } }

/* ── Galera carry/borrow animations ── */
.floating-digit {
  position: fixed; z-index: 200; pointer-events: none;
  font-size: 1.5rem; font-weight: 800; color: var(--color-accent);
  font-family: 'Courier New', monospace;
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.galera-cell.carry-bounce {
  animation: carryBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes carryBounce {
  0% { transform: scale(0.3); opacity: 0; }
  60% { transform: scale(1.2); }
  100% { transform: scale(1); opacity: 1; }
}
.galera-strike {
  pointer-events: none; z-index: 50;
  transition: width 0.3s ease;
}

/* ── Narration responsive ── */
@media (max-width: 768px) {
  .narration-bar { max-width: 100%; padding: 12px 16px; }
  .narration-text { font-size: 1.05rem; }
}
@media (max-width: 480px) {
  .narration-bar { padding: 10px 12px; gap: 8px; }
  .narration-icon { font-size: 1.4rem; }
  .narration-text { font-size: 0.95rem; }
}
</style>
</head>
<body>

<div class="header">
  <h1>Place Value Addition</h1>
  <a class="btn-home" href="index.html">Home</a>
  <select id="difficultySelect" aria-label="Difficulty">
    <option value="easy">Easy</option>
    <option value="medium" selected>Medium</option>
    <option value="hard">Hard</option>
  </select>
  <button class="btn-new" id="btnNew">New Problem</button>
  <button class="btn-guide header-btn active" id="btnGuide">Guide: On</button>
  <span class="problem-counter" id="problemCounter">Solved: 0</span>
</div>

<div class="main">

  <!-- Galera -->
  <div class="galera-section">
    <div class="galera">
      <div class="galera-row" style="margin-bottom:8px;">
        <div class="galera-label"></div>
        <div class="galera-col-header">H</div>
        <div class="galera-col-header">T</div>
        <div class="galera-col-header">O</div>
      </div>
      <div class="galera-row carry-row">
        <div class="galera-label"></div>
        <div class="galera-carry-slot"><input class="galera-cell carry" id="carry-h" maxlength="1" inputmode="numeric" aria-label="Carry hundreds"></div>
        <div class="galera-carry-slot"><input class="galera-cell carry" id="carry-t" maxlength="1" inputmode="numeric" aria-label="Carry tens"></div>
        <div class="galera-carry-slot"></div>
      </div>
      <div class="galera-row">
        <div class="galera-label"></div>
        <input class="galera-cell" id="g-a1-h" maxlength="1" inputmode="numeric" aria-label="Addend 1 hundreds">
        <input class="galera-cell" id="g-a1-t" maxlength="1" inputmode="numeric" aria-label="Addend 1 tens">
        <input class="galera-cell" id="g-a1-o" maxlength="1" inputmode="numeric" aria-label="Addend 1 ones">
      </div>
      <div class="galera-row divider">
        <div class="galera-label">+</div>
        <input class="galera-cell" id="g-a2-h" maxlength="1" inputmode="numeric" aria-label="Addend 2 hundreds">
        <input class="galera-cell" id="g-a2-t" maxlength="1" inputmode="numeric" aria-label="Addend 2 tens">
        <input class="galera-cell" id="g-a2-o" maxlength="1" inputmode="numeric" aria-label="Addend 2 ones">
      </div>
      <div class="galera-row">
        <div class="galera-label">=</div>
        <input class="galera-cell" id="g-r-h" maxlength="1" inputmode="numeric" aria-label="Result hundreds">
        <input class="galera-cell" id="g-r-t" maxlength="1" inputmode="numeric" aria-label="Result tens">
        <input class="galera-cell" id="g-r-o" maxlength="1" inputmode="numeric" aria-label="Result ones">
      </div>
    </div>
    <div class="entry-hint" id="entryHint">Type your own numbers or press New</div>
    <div class="estimate-prompt" id="estimatePrompt">
      <span>Estimate:</span>
      <input type="text" id="estimateInput" inputmode="numeric" maxlength="4" autocomplete="off" placeholder="?">
      <span class="estimate-result" id="estimateResult"></span>
    </div>
    <div class="guide-prompt" id="guidePrompt" aria-live="polite">
      <span id="guideText"></span>
      <input type="text" id="guideInput" inputmode="numeric" autocomplete="off">
    </div>
    <div class="narration-bar" id="narrationBar" aria-live="polite">
      <div class="narration-icon" id="narrationIcon">&#x1F9D1;&#x200D;&#x1F3EB;</div>
      <div class="narration-text" id="narrationText"></div>
    </div>
    <div class="galera-buttons">
      <button class="btn-clear" id="btnClear">Clear</button>
      <button class="btn-check" id="btnCheck" disabled>Check Answer</button>
    </div>
  </div>

  <!-- Mat (collapsible) -->
  <div class="mat-section" id="matSection">
    <div class="mat-toggle" id="matToggle">
      <span class="arrow">&#9660;</span> Need help? Use Visual Blocks
    </div>
    <div class="mat-body">
      <div class="mat" id="theMat">
        <div class="mat-header">Hundreds<small>(100)</small></div>
        <div class="mat-header">Tens<small>(10)</small></div>
        <div class="mat-header">Ones<small>(1)</small></div>

        <div class="mat-cell hundreds-col row-addend1" id="mat-a1-h"><span class="mat-row-label">First Number</span></div>
        <div class="mat-cell tens-col row-addend1" id="mat-a1-t"></div>
        <div class="mat-cell ones-col row-addend1" id="mat-a1-o"></div>

        <div class="mat-cell hundreds-col row-addend2" id="mat-a2-h"><span class="mat-row-label">Second Number</span></div>
        <div class="mat-cell tens-col row-addend2" id="mat-a2-t"></div>
        <div class="mat-cell ones-col row-addend2" id="mat-a2-o"></div>

        <div class="mat-cell hundreds-col row-result" id="mat-r-h"><span class="mat-row-label">Result</span></div>
        <div class="mat-cell tens-col row-result" id="mat-r-t"></div>
        <div class="mat-cell ones-col row-result" id="mat-r-o"></div>
      </div>
      <div class="count-bar" id="countBar">
        <div class="count-cell" id="count-h">Flats<span class="count-num">0</span></div>
        <div class="count-cell" id="count-t">Rods<span class="count-num">0</span></div>
        <div class="count-cell" id="count-o">Units<span class="count-num">0</span></div>
        <div class="count-total">Counted: <span class="count-formed" id="countFormed">0</span></div>
      </div>
      <div class="mat-actions-wrap">
        <button class="btn btn-combine" id="btnCombine" disabled>Combine</button>
        <button class="btn btn-regroup" id="btnRegroup">Regroup!</button>
      </div>
    </div>
  </div>

  <!-- Expanded Notation (collapsible) -->
  <div class="expanded-section collapsed" id="expandedSection">
    <div class="expanded-toggle" id="expandedToggle">
      <span class="arrow">&#9660;</span> Expanded Notation
    </div>
    <div class="expanded-body" id="expandedBody"></div>
  </div>

  <!-- Number Line (collapsible) -->
  <div class="numline-section collapsed" id="numlineSection">
    <div class="numline-toggle" id="numlineToggle">
      <span class="arrow">&#9660;</span> Number Line
    </div>
    <div class="numline-body">
      <svg class="numline-svg" id="numlineSvg" viewBox="0 0 600 120"></svg>
    </div>
  </div>

</div>

<div class="feedback-overlay" id="feedbackOverlay" role="alert" aria-live="assertive"></div>

<script>
// ═══════════════════════════════════════════
// State
// ═══════════════════════════════════════════
const state = {
  difficulty: 'medium',
  num1: 0, num2: 0,
  phase: 'input',
  carries: { tens: 0, hundreds: 0 },
  animating: false,
  combined:  { ones: 0, tens: 0, hundreds: 0 },
  regrouped: { ones: 0, tens: 0, hundreds: 0 },
  answered: false,
  matCollapsed: localStorage.getItem('matCollapsed') !== null ? localStorage.getItem('matCollapsed') === 'true' : false,
  guide: 'ones', // null | 'ones' | 'tens' | 'hundreds' | 'done'
  guideEnabled: true, // whether guide mode is on
  solvedCount: 0,
  numlineCollapsed: true,
  expandedCollapsed: true,
  streak: 0,
  estimateShown: false,
};

function setState(u) { Object.assign(state, u); render(); }

// Entry hint — show on first visit, hide after first custom entry
(function() {
  const hint = document.getElementById('entryHint');
  if (localStorage.getItem('customEntryUsed')) hint.style.display = 'none';
})();
function dismissEntryHint() {
  if (localStorage.getItem('customEntryUsed')) return;
  localStorage.setItem('customEntryUsed', '1');
  const hint = document.getElementById('entryHint');
  hint.style.opacity = '0';
  setTimeout(() => { hint.style.display = 'none'; }, 300);
}

// ═══════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════
function digits(n) {
  return { hundreds: Math.floor(n/100), tens: Math.floor((n%100)/10), ones: n%10 };
}
function digitDisplay(d) {
  return {
    hundreds: d.hundreds || '',
    tens:  d.hundreds ? String(d.tens) : (d.tens || ''),
    ones: (d.hundreds || d.tens) ? String(d.ones) : (d.ones || ''),
  };
}
function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

// ═══════════════════════════════════════════
// Narration & Audio
// ═══════════════════════════════════════════
function setNarration(text) {
  const bar = document.getElementById('narrationBar');
  const textEl = document.getElementById('narrationText');
  textEl.style.opacity = '0';
  bar.classList.add('visible');
  setTimeout(() => { textEl.textContent = text; textEl.style.opacity = '1'; }, 200);
}
function clearNarration() {
  const bar = document.getElementById('narrationBar');
  const textEl = document.getElementById('narrationText');
  textEl.style.opacity = '0';
  setTimeout(() => { textEl.textContent = ''; bar.classList.remove('visible'); }, 300);
}

// ═══════════════════════════════════════════
// Movement Arrows
// ═══════════════════════════════════════════
function showMovementArrow(fromCellId, toCellId) {
  const matBody = document.querySelector('.mat-body');
  matBody.style.position = 'relative';
  const bodyRect = matBody.getBoundingClientRect();
  const fromEl = document.getElementById(fromCellId);
  const toEl = document.getElementById(toCellId);
  const fromRect = fromEl.getBoundingClientRect();
  const toRect = toEl.getBoundingClientRect();

  const x1 = fromRect.left + fromRect.width / 2 - bodyRect.left;
  const y1 = fromRect.top + fromRect.height / 4 - bodyRect.top;
  const x2 = toRect.left + toRect.width / 2 - bodyRect.left;
  const y2 = toRect.top + toRect.height / 4 - bodyRect.top;

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('movement-arrow');
  svg.setAttribute('width', bodyRect.width);
  svg.setAttribute('height', bodyRect.height);

  const markerId = 'ah-' + Date.now();
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  marker.setAttribute('id', markerId);
  marker.setAttribute('markerWidth', '10'); marker.setAttribute('markerHeight', '7');
  marker.setAttribute('refX', '10'); marker.setAttribute('refY', '3.5');
  marker.setAttribute('orient', 'auto');
  const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  poly.setAttribute('points', '0 0, 10 3.5, 0 7');
  poly.setAttribute('fill', '#E8573A');
  marker.appendChild(poly); defs.appendChild(marker); svg.appendChild(defs);

  const midX = (x1 + x2) / 2;
  const midY = Math.min(y1, y2) - 30;
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', `M${x1},${y1} Q${midX},${midY} ${x2},${y2}`);
  path.setAttribute('stroke', '#E8573A');
  path.setAttribute('stroke-width', '3');
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke-dasharray', '8 4');
  path.setAttribute('marker-end', `url(#${markerId})`);
  svg.appendChild(path);

  matBody.appendChild(svg);
  return svg;
}
function removeMovementArrows() {
  document.querySelectorAll('.movement-arrow').forEach(el => el.remove());
}

// ═══════════════════════════════════════════
// Galera Carry Animation
// ═══════════════════════════════════════════
function animateCarryFlyUp(fromCellId, toCarryCellId, digit) {
  return new Promise(resolve => {
    const fromEl = document.getElementById(fromCellId);
    const toEl = document.getElementById(toCarryCellId);
    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();

    const floater = document.createElement('div');
    floater.className = 'floating-digit';
    floater.textContent = digit;
    floater.style.left = (fromRect.left + fromRect.width / 2 - 10) + 'px';
    floater.style.top = (fromRect.top + fromRect.height / 2 - 12) + 'px';
    document.body.appendChild(floater);

    void floater.offsetWidth;
    floater.style.left = (toRect.left + toRect.width / 2 - 10) + 'px';
    floater.style.top = (toRect.top + toRect.height / 2 - 12) + 'px';
    floater.style.fontSize = '1.1rem';

    floater.addEventListener('transitionend', () => {
      floater.remove();
      toEl.value = digit;
      toEl.classList.add('carry-bounce');
      setTimeout(() => toEl.classList.remove('carry-bounce'), 500);
      resolve();
    }, { once: true });
  });
}

// ═══════════════════════════════════════════
// Blocks
// ═══════════════════════════════════════════
function createBlocks(count, type) {
  const f = document.createDocumentFragment();
  for (let i = 0; i < count; i++) {
    const el = document.createElement('div');
    el.className = `block ${type} entrance`;
    el.style.animationDelay = `${i * 0.04}s`;
    f.appendChild(el);
  }
  return f;
}
function clearCell(id) {
  const c = document.getElementById(id);
  const l = c.querySelector('.mat-row-label');
  c.innerHTML = '';
  if (l) c.appendChild(l);
}
function fillCell(id, count, type) {
  clearCell(id);
  document.getElementById(id).appendChild(createBlocks(count, type));
}
function renderMatInput() {
  const d1 = digits(state.num1), d2 = digits(state.num2);
  fillCell('mat-a1-h', d1.hundreds, 'flat');
  fillCell('mat-a1-t', d1.tens, 'rod');
  fillCell('mat-a1-o', d1.ones, 'unit');
  fillCell('mat-a2-h', d2.hundreds, 'flat');
  fillCell('mat-a2-t', d2.tens, 'rod');
  fillCell('mat-a2-o', d2.ones, 'unit');
  clearCell('mat-r-h'); clearCell('mat-r-t'); clearCell('mat-r-o');
  updateCountBar();
}
function renderMatCombined() {
  ['mat-a1-h','mat-a1-t','mat-a1-o','mat-a2-h','mat-a2-t','mat-a2-o'].forEach(clearCell);
  fillCell('mat-r-h', state.combined.hundreds, 'flat');
  fillCell('mat-r-t', state.combined.tens, 'rod');
  fillCell('mat-r-o', state.combined.ones, 'unit');
  updateCountBar();
}

// ═══════════════════════════════════════════
// Count Bar
// ═══════════════════════════════════════════
function updateCountBar() {
  const mat = document.getElementById('theMat');
  const flats = mat.querySelectorAll('.block.flat.counted').length;
  const rods  = mat.querySelectorAll('.block.rod.counted').length;
  const units = mat.querySelectorAll('.block.unit.counted').length;

  document.querySelector('#count-h .count-num').textContent = flats;
  document.querySelector('#count-t .count-num').textContent = rods;
  document.querySelector('#count-o .count-num').textContent = units;

  const total = flats * 100 + rods * 10 + units;
  document.getElementById('countFormed').textContent = total;
}

// ═══════════════════════════════════════════
// Galera refs
// ═══════════════════════════════════════════
const G = {
  a1h: document.getElementById('g-a1-h'),
  a1t: document.getElementById('g-a1-t'),
  a1o: document.getElementById('g-a1-o'),
  a2h: document.getElementById('g-a2-h'),
  a2t: document.getElementById('g-a2-t'),
  a2o: document.getElementById('g-a2-o'),
  rh:  document.getElementById('g-r-h'),
  rt:  document.getElementById('g-r-t'),
  ro:  document.getElementById('g-r-o'),
  ch:  document.getElementById('carry-h'),
  ct:  document.getElementById('carry-t'),
};

function setGaleraAddends() {
  const d1 = digitDisplay(digits(state.num1));
  const d2 = digitDisplay(digits(state.num2));
  G.a1h.value = d1.hundreds; G.a1t.value = d1.tens; G.a1o.value = d1.ones;
  G.a2h.value = d2.hundreds; G.a2t.value = d2.tens; G.a2o.value = d2.ones;
}
function clearGaleraResults() {
  G.rh.value=''; G.rt.value=''; G.ro.value='';
  G.ch.value=''; G.ct.value='';
  ['rh','rt','ro'].forEach(k => G[k].classList.remove('correct','incorrect'));
}
function lockInputs(keys, lock) {
  keys.forEach(k => { G[k].readOnly = lock; G[k].classList.toggle('readonly', lock); });
}

// ═══════════════════════════════════════════
// Render
// ═══════════════════════════════════════════
function render() {
  const btnCombine = document.getElementById('btnCombine');
  const btnRegroup = document.getElementById('btnRegroup');
  const btnCheck   = document.getElementById('btnCheck');
  const hasNumbers = state.num1 > 0 && state.num2 > 0;

  btnCombine.disabled = state.phase !== 'input' || !hasNumbers || state.animating;

  const needsRegroup = state.phase === 'regrouping-ones' || state.phase === 'regrouping-tens';
  btnRegroup.classList.toggle('show', needsRegroup && !state.animating);

  lockInputs(['a1h','a1t','a1o','a2h','a2t','a2o'], state.animating);
  lockInputs(['rh','rt','ro'], !hasNumbers);
  btnCheck.disabled = !hasNumbers || state.animating;

  // Regroup cell highlighting
  const onesCell = document.getElementById('mat-r-o');
  const tensCell = document.getElementById('mat-r-t');

  onesCell.classList.toggle('needs-regroup', state.phase === 'regrouping-ones');
  tensCell.classList.toggle('needs-regroup', state.phase === 'regrouping-tens');

  // Regroup badges
  onesCell.querySelector('.regroup-badge')?.remove();
  tensCell.querySelector('.regroup-badge')?.remove();
  if (state.phase === 'regrouping-ones' && !state.animating) {
    const b = document.createElement('span');
    b.className = 'regroup-badge';
    b.textContent = '10+ !';
    onesCell.appendChild(b);
  }
  if (state.phase === 'regrouping-tens' && !state.animating) {
    const b = document.createElement('span');
    b.className = 'regroup-badge';
    b.textContent = '10+ !';
    tensCell.appendChild(b);
  }

  // Collapse state
  document.getElementById('matSection').classList.toggle('collapsed', state.matCollapsed);

  // Guide rendering
  const guideEl = document.getElementById('guidePrompt');
  const guideTextEl = document.getElementById('guideText');
  const guideInput = document.getElementById('guideInput');
  const btnGuide = document.getElementById('btnGuide');
  ['ro','rt','rh'].forEach(k => G[k].classList.remove('guide-active'));
  if (state.guide && state.guide !== 'done') {
    guideTextEl.textContent = getGuidePrompt();
    guideEl.classList.add('show');
    btnGuide.classList.add('active');
    btnGuide.textContent = 'Guide: On';
    const key = state.guide === 'ones' ? 'ro' : state.guide === 'tens' ? 'rt' : 'rh';
    G[key].classList.add('guide-active');
    // Lock result + carry cells during guide mode
    lockInputs(['rh','rt','ro'], true);
    lockInputs(['ch','ct'], true);
  } else {
    guideEl.classList.remove('show');
    btnGuide.classList.toggle('active', state.guideEnabled);
    btnGuide.textContent = state.guideEnabled ? 'Guide: On' : 'Guide: Off';
    // Unlock result + carry cells when guide is off
    if (!state.guideEnabled || state.guide === 'done') {
      lockInputs(['ch','ct'], false);
    }
  }

  // Expanded notation collapse state
  document.getElementById('expandedSection').classList.toggle('collapsed', state.expandedCollapsed);
  if (!state.expandedCollapsed && hasNumbers) renderExpandedNotation();

  // Number line collapse state
  document.getElementById('numlineSection').classList.toggle('collapsed', state.numlineCollapsed);
  if (!state.numlineCollapsed && hasNumbers) renderNumberLine();
}

// ═══════════════════════════════════════════
// Expanded Notation
// ═══════════════════════════════════════════
function expandedNotationStr(n) {
  const d = digits(n);
  const parts = [];
  if (d.hundreds) parts.push('<span class="place-h">' + (d.hundreds * 100) + '</span>');
  if (d.tens) parts.push('<span class="place-t">' + (d.tens * 10) + '</span>');
  if (d.ones || parts.length === 0) parts.push('<span class="place-o">' + d.ones + '</span>');
  return n + ' = ' + parts.join(' + ');
}
function renderExpandedNotation() {
  const body = document.getElementById('expandedBody');
  const result = state.num1 + state.num2;
  body.innerHTML =
    '<div class="expanded-row">' + expandedNotationStr(state.num1) + '</div>' +
    '<div class="expanded-row">+ ' + expandedNotationStr(state.num2) + '</div>' +
    '<div class="expanded-row" style="border-top:2px solid #ccc;margin-top:4px;padding-top:4px;">= ' + expandedNotationStr(result) + '</div>';
}

// ═══════════════════════════════════════════
// Number Line
// ═══════════════════════════════════════════
function renderNumberLine() {
  const svg = document.getElementById('numlineSvg');
  svg.innerHTML = '';
  const ns = 'http://www.w3.org/2000/svg';
  const a = state.num1, b = state.num2, result = a + b;
  const maxVal = result;
  if (maxVal <= 0) return;

  const pad = 50, lineY = 80, w = 600;
  const usable = w - pad * 2;

  // Determine tick points — show: 0, a, result (and optionally nice intermediate ticks)
  const points = [0, a, result];
  const unique = [...new Set(points)].sort((x, y) => x - y);

  function x(val) { return pad + (val / maxVal) * usable; }

  // Main line
  const line = document.createElementNS(ns, 'line');
  Object.entries({ x1: pad - 10, y1: lineY, x2: w - pad + 10, y2: lineY, stroke: '#999', 'stroke-width': 2 }).forEach(([k, v]) => line.setAttribute(k, v));
  svg.appendChild(line);

  // Tick marks & labels
  unique.forEach(val => {
    const tx = x(val);
    const tick = document.createElementNS(ns, 'line');
    Object.entries({ x1: tx, y1: lineY - 6, x2: tx, y2: lineY + 6, stroke: '#333', 'stroke-width': 2 }).forEach(([k, v]) => tick.setAttribute(k, v));
    svg.appendChild(tick);
    const label = document.createElementNS(ns, 'text');
    Object.entries({ x: tx, y: lineY + 22, 'text-anchor': 'middle', fill: '#333', 'font-size': '13px', 'font-weight': '600' }).forEach(([k, v]) => label.setAttribute(k, v));
    label.textContent = val;
    svg.appendChild(label);
  });

  // Jump arc: from a, jump +b to result
  if (b > 0) {
    const x1 = x(a), x2 = x(result);
    const midX = (x1 + x2) / 2;
    const arcH = Math.min(45, Math.max(20, (x2 - x1) * 0.3));
    const path = document.createElementNS(ns, 'path');
    path.setAttribute('d', `M${x1},${lineY} Q${midX},${lineY - arcH} ${x2},${lineY}`);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', '#4A90D9');
    path.setAttribute('stroke-width', '2.5');
    path.setAttribute('marker-end', 'url(#arrowhead)');
    svg.appendChild(path);

    // Jump label
    const jumpLabel = document.createElementNS(ns, 'text');
    Object.entries({ x: midX, y: lineY - arcH - 6, 'text-anchor': 'middle', fill: '#4A90D9', 'font-size': '14px', 'font-weight': '700' }).forEach(([k, v]) => jumpLabel.setAttribute(k, v));
    jumpLabel.textContent = '+' + b;
    svg.appendChild(jumpLabel);
  }

  // Dot on starting number
  const dot = document.createElementNS(ns, 'circle');
  Object.entries({ cx: x(a), cy: lineY, r: 5, fill: '#E8573A' }).forEach(([k, v]) => dot.setAttribute(k, v));
  svg.appendChild(dot);

  // Arrowhead marker
  const defs = document.createElementNS(ns, 'defs');
  const marker = document.createElementNS(ns, 'marker');
  Object.entries({ id: 'arrowhead', markerWidth: 8, markerHeight: 6, refX: 8, refY: 3, orient: 'auto' }).forEach(([k, v]) => marker.setAttribute(k, v));
  const poly = document.createElementNS(ns, 'polygon');
  poly.setAttribute('points', '0 0, 8 3, 0 6');
  poly.setAttribute('fill', '#4A90D9');
  marker.appendChild(poly);
  defs.appendChild(marker);
  svg.insertBefore(defs, svg.firstChild);
}

// ═══════════════════════════════════════════
// Problem Generator
// ═══════════════════════════════════════════
function randInt(a,b) { return Math.floor(Math.random()*(b-a+1))+a; }
function needsCarry(a,b) {
  const da=digits(a),db=digits(b);
  return (da.ones+db.ones>=10)||(da.tens+db.tens>=10);
}
function carryCount(a,b) {
  const da=digits(a),db=digits(b);
  let c=0,co=0;
  if(da.ones+db.ones>=10){c++;co=1;}
  if(da.tens+db.tens+co>=10){c++;}
  return c;
}
function generateProblem() {
  const d=state.difficulty; let a,b;
  if(d==='easy'){ do{a=randInt(1,99);b=randInt(1,99);}while(needsCarry(a,b)||a+b>999); }
  else if(d==='medium'){ do{a=randInt(1,499);b=randInt(1,499);}while(carryCount(a,b)>1||a+b>999); }
  else{ do{a=randInt(100,999);b=randInt(100,999);}while(a+b>999); }
  return {a,b};
}

function readGaleraAddends() {
  return {
    num1: (parseInt(G.a1h.value)||0)*100 + (parseInt(G.a1t.value)||0)*10 + (parseInt(G.a1o.value)||0),
    num2: (parseInt(G.a2h.value)||0)*100 + (parseInt(G.a2t.value)||0)*10 + (parseInt(G.a2o.value)||0),
  };
}

// ═══════════════════════════════════════════
// Animation helpers
// ═══════════════════════════════════════════
function cleanAnimClasses(el) {
  el.classList.remove('entrance','slide-down','highlight','shrink-away','pop-in');
}
function animateElement(el, cls) {
  return new Promise(resolve => {
    cleanAnimClasses(el);
    void el.offsetWidth;
    el.classList.add(cls);
    el.addEventListener('animationend', () => resolve(), { once: true });
  });
}

// ═══════════════════════════════════════════
// Combine
// ═══════════════════════════════════════════
async function doCombine() {
  if (state.animating) return;
  setState({ animating: true });
  setNarration("Let's slide the blocks together!");
  const d1=digits(state.num1), d2=digits(state.num2);
  const combined = {
    ones: d1.ones+d2.ones, tens: d1.tens+d2.tens, hundreds: d1.hundreds+d2.hundreds,
  };
  state.combined = {...combined};
  state.regrouped = {...combined};
  renderMatCombined();
  document.querySelectorAll('.row-result .block').forEach((b,i) => {
    cleanAnimClasses(b); b.classList.add('slide-down');
    b.style.animationDelay = `${i*0.03}s`;
  });
  await wait(1200);
  setNarration("Good! Now count the blocks in each column.");
  await wait(2000);
  clearNarration();
  setState({ phase: nextRegroupPhase(combined,'combined'), animating: false });
}

function nextRegroupPhase(counts, from) {
  if (from==='combined' && counts.ones>=10) return 'regrouping-ones';
  if ((from==='combined'||from==='regrouping-ones') && counts.tens>=10) return 'regrouping-tens';
  return 'mat-done';
}

// ═══════════════════════════════════════════
// Regroup — NO auto-fill of carry row
// ═══════════════════════════════════════════
async function doRegroup() {
  if (state.animating) return;
  setState({ animating: true });
  const d1 = digits(state.num1), d2 = digits(state.num2);
  if (state.phase === 'regrouping-ones') {
    await regroupColumn('mat-r-o','.block.unit','mat-r-t','rod',
      () => { state.regrouped.ones-=10; state.regrouped.tens+=1; state.carries.tens=1; },
      () => nextRegroupPhase(state.regrouped,'regrouping-ones'),
      { sumText: `${d1.ones} + ${d2.ones} = ${state.combined.ones}`,
        total: state.combined.ones, colName: 'ones',
        destColName: 'tens', destBlockName: 'ten',
        remainder: state.combined.ones - 10, carryCell: 'carry-t',
        resultCell: 'g-r-o' }
    );
  } else if (state.phase === 'regrouping-tens') {
    const carryNote = state.carries.tens ? ` + 1 carry` : '';
    await regroupColumn('mat-r-t','.block.rod','mat-r-h','flat',
      () => { state.regrouped.tens-=10; state.regrouped.hundreds+=1; state.carries.hundreds=1; },
      () => 'mat-done',
      { sumText: `${d1.tens} + ${d2.tens}${carryNote} = ${state.regrouped.tens}`,
        total: state.regrouped.tens, colName: 'tens',
        destColName: 'hundreds', destBlockName: 'hundred',
        remainder: state.regrouped.tens - 10, carryCell: 'carry-h',
        resultCell: 'g-r-t' }
    );
  }
  setState({ animating: false });
}

async function regroupColumn(srcId, sel, destId, newType, updateFn, nextFn, narr) {
  const src = document.getElementById(srcId);
  const blocks = Array.from(src.querySelectorAll(sel));

  // Step 1: Narrate the sum
  setNarration(`${narr.sumText} ${narr.colName}. That's more than 10!`);

  await wait(2500);

  // Step 2: Count 10 blocks with highlight
  setNarration(`Let's count 10 ${narr.colName}...`);
  for (let i = 0; i < 10 && i < blocks.length; i++) {
    cleanAnimClasses(blocks[i]); void blocks[i].offsetWidth;
    blocks[i].classList.add('highlight');
  }
  await wait(1500);

  // Step 3: Trade narration
  setNarration(`10 ${narr.colName} = 1 ${narr.destBlockName}! Let's trade them.`);

  await wait(2000);

  // Step 4: Show arrow from source to destination
  const arrow = showMovementArrow(srcId, destId);
  await wait(800);

  // Step 5: Shrink away the 10 blocks

  const p = [];
  for (let i = 0; i < 10 && i < blocks.length; i++) p.push(animateElement(blocks[i], 'shrink-away'));
  await Promise.all(p);
  for (let i = 0; i < 10 && i < blocks.length; i++) blocks[i].remove();

  // Step 6: Pop in new block at destination
  const dest = document.getElementById(destId);
  const nb = document.createElement('div');
  nb.className = `block ${newType} pop-in`;
  dest.appendChild(nb);

  updateFn();
  await wait(600);

  // Step 7: Remove arrow
  arrow.remove();

  // Step 8: Carry fly-up in galera + narration
  setNarration(`We carry 1 to the ${narr.destColName}. ${narr.remainder} ${narr.colName} stay here.`);

  await animateCarryFlyUp(narr.resultCell, narr.carryCell, '1');
  await wait(2000);

  // Step 9: Clear narration
  clearNarration();
  await wait(300);

  updateCountBar();
  setState({ phase: nextFn() });
}

// ═══════════════════════════════════════════
// Check Answer
// ═══════════════════════════════════════════
function checkAnswer() {
  ['rh','rt','ro','ch','ct'].forEach(k => G[k].classList.remove('correct','incorrect'));
  const sum=state.num1+state.num2, cd=digits(sum);
  const steps=getAdditionSteps();
  const uh=parseInt(G.rh.value)||0, ut=parseInt(G.rt.value)||0, uo=parseInt(G.ro.value)||0;
  let ok=true;
  [['rh',uh,cd.hundreds],['rt',ut,cd.tens],['ro',uo,cd.ones]].forEach(([k,u,c])=>{
    if(u===c) G[k].classList.add('correct');
    else { G[k].classList.add('incorrect'); ok=false; }
  });
  // Validate carries
  const expectedCT = steps.ones.fullSum >= 10 ? 1 : 0;
  const expectedCH = steps.tens.fullSum >= 10 ? 1 : 0;
  const userCT = parseInt(G.ct.value) || 0;
  const userCH = parseInt(G.ch.value) || 0;
  if (expectedCT > 0 || G.ct.value !== '') {
    if (userCT === expectedCT) G.ct.classList.add('correct');
    else G.ct.classList.add('incorrect');
  }
  if (expectedCH > 0 || G.ch.value !== '') {
    if (userCH === expectedCH) G.ch.classList.add('correct');
    else G.ch.classList.add('incorrect');
  }
  if(ok){ state.streak = Math.max(state.streak, 0) + 1; celebrate(); setState({answered:true}); checkAdaptiveDifficulty(); }
  else { state.streak = Math.min(state.streak, 0) - 1; showHint(); checkAdaptiveDifficulty(); }
}

// ═══════════════════════════════════════════
// Celebration / Hint / Audio
// ═══════════════════════════════════════════
function celebrate() {
  state.solvedCount++;
  document.getElementById('problemCounter').textContent = 'Solved: ' + state.solvedCount;
  showConfetti();
  const ov=document.getElementById('feedbackOverlay');
  ov.innerHTML='<div class="feedback-message">Great job!</div>';
  ov.classList.add('show');
  setTimeout(()=>{ov.classList.remove('show');ov.innerHTML='';clearConfetti();},3000);
}
function checkAdaptiveDifficulty() {
  const levels = ['easy', 'medium', 'hard'];
  const idx = levels.indexOf(state.difficulty);
  let suggestion = null;
  if (state.streak <= -3 && idx > 0) {
    suggestion = { text: 'Finding it tough? Try ', level: levels[idx - 1] };
  } else if (state.streak >= 5 && idx < 2) {
    suggestion = { text: 'You\'re on a roll! Try ', level: levels[idx + 1] };
  }
  // Remove existing suggestion
  document.querySelectorAll('.difficulty-suggestion').forEach(e => e.remove());
  if (!suggestion) return;
  const el = document.createElement('div');
  el.className = 'difficulty-suggestion';
  el.innerHTML = suggestion.text + '<button id="adaptBtn">' + suggestion.level.charAt(0).toUpperCase() + suggestion.level.slice(1) + '</button>' +
    '<button class="dismiss-btn" id="adaptDismiss">\u00d7</button>';
  document.body.appendChild(el);
  document.getElementById('adaptBtn').addEventListener('click', () => {
    state.difficulty = suggestion.level;
    document.getElementById('difficultySelect').value = suggestion.level;
    state.streak = 0;
    el.remove();
    newProblem();
  });
  document.getElementById('adaptDismiss').addEventListener('click', () => {
    state.streak = 0;
    el.classList.add('fade-out');
    el.addEventListener('animationend', () => el.remove(), { once: true });
  });
  setTimeout(() => { if (el.parentNode) { el.classList.add('fade-out'); el.addEventListener('animationend', () => el.remove(), { once: true }); } }, 8000);
}
function showConfetti() {
  const colors=['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#FF8C00','#7B68EE'];
  if(!document.getElementById('confetti-kf')){
    const s=document.createElement('style');s.id='confetti-kf';
    s.textContent=`@keyframes confettiFall{0%{transform:translateY(0) translateX(0) rotate(0);opacity:1}100%{transform:translateY(100vh) translateX(var(--drift)) rotate(var(--rot));opacity:0}}`;
    document.head.appendChild(s);
  }
  for(let i=0;i<30;i++){
    const p=document.createElement('div');p.className='confetti-piece';
    p.style.left=Math.random()*100+'vw';
    p.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
    p.style.width=(Math.random()*8+6)+'px';p.style.height=(Math.random()*8+6)+'px';
    p.style.borderRadius=Math.random()>0.5?'50%':'2px';
    p.style.setProperty('--drift',(Math.random()*200-100).toFixed(0)+'px');
    p.style.setProperty('--rot',(Math.random()*720).toFixed(0)+'deg');
    p.style.animation=`confettiFall ${(Math.random()*2+1.5).toFixed(2)}s ${(Math.random()*0.5).toFixed(2)}s ease-in forwards`;
    document.body.appendChild(p);
  }
}
function clearConfetti(){document.querySelectorAll('.confetti-piece').forEach(e=>e.remove());}
function showHint() {

  document.querySelectorAll('.hint-toast').forEach(e=>e.remove());
  const t=document.createElement('div');t.className='hint-toast';
  t.textContent='Count the blocks in each column and try again!';
  document.body.appendChild(t);
  setTimeout(()=>{t.classList.add('fade-out');t.addEventListener('animationend',()=>t.remove(),{once:true});},2500);
}
// ═══════════════════════════════════════════
// New Problem / Reset
// ═══════════════════════════════════════════
function resetToInput() {
  clearNarration(); removeMovementArrows();
  clearGaleraResults();
  state.phase='input'; state.carries={tens:0,hundreds:0};
  state.combined={ones:0,tens:0,hundreds:0};
  state.regrouped={ones:0,tens:0,hundreds:0};
  state.animating=false; state.answered=false;
  renderMatInput(); render();
}
function newProblem() {
  const {a,b}=generateProblem();
  clearNarration(); removeMovementArrows(); clearConfetti();
  document.getElementById('feedbackOverlay').classList.remove('show');
  document.querySelectorAll('.hint-toast').forEach(e=>e.remove());
  state.num1=a; state.num2=b;
  resetToInput(); setGaleraAddends();
  state.guide = state.guideEnabled ? 'ones' : null;
  showEstimatePrompt();
  render();
  if (state.estimateShown) document.getElementById('estimateInput').focus();
  else if (state.guide) document.getElementById('guideInput').focus();
}
function showEstimatePrompt() {
  const el = document.getElementById('estimatePrompt');
  const input = document.getElementById('estimateInput');
  const result = document.getElementById('estimateResult');
  input.value = ''; result.textContent = ''; result.className = 'estimate-result';
  state.estimateShown = true;
  el.classList.add('show');
}
function dismissEstimate() {
  state.estimateShown = false;
  document.getElementById('estimatePrompt').classList.remove('show');
}
function checkEstimate() {
  const input = document.getElementById('estimateInput');
  const result = document.getElementById('estimateResult');
  const guess = parseInt(input.value);
  if (isNaN(guess)) return;
  const actual = state.num1 + state.num2;
  const diff = Math.abs(guess - actual);
  const threshold = Math.max(actual * 0.2, 10); // within 20% or 10
  if (diff <= threshold) {
    result.textContent = 'Close!';
    result.className = 'estimate-result close';
  } else {
    result.textContent = 'Not quite!';
    result.className = 'estimate-result far';
  }
  setTimeout(() => dismissEstimate(), 1500);
}

// ═══════════════════════════════════════════
// Guide
// ═══════════════════════════════════════════
function getAdditionSteps() {
  const d1=digits(state.num1), d2=digits(state.num2);
  const oS=d1.ones+d2.ones, oC=oS>=10?1:0;
  const tS=d1.tens+d2.tens+oC, tC=tS>=10?1:0;
  const hS=d1.hundreds+d2.hundreds+tC;
  return {
    ones: {a:d1.ones, b:d2.ones, carry:0, result:oS%10, fullSum:oS},
    tens: {a:d1.tens, b:d2.tens, carry:oC, result:tS%10, fullSum:tS},
    hundreds: {a:d1.hundreds, b:d2.hundreds, carry:tC, result:hS, fullSum:hS},
    needsHundreds: hS > 0,
  };
}
function getGuidePrompt() {
  if (!state.guide || state.guide==='done') return '';
  const exp=getAdditionSteps(), info=exp[state.guide];
  const col=state.guide.charAt(0).toUpperCase()+state.guide.slice(1);
  let parts=[String(info.a),String(info.b)];
  if (info.carry) parts.push(info.carry+' (carry)');
  return col+': '+parts.join(' + ')+' = ?';
}
async function checkGuideStep() {
  if (!state.guide || state.guide==='done' || state.animating) return;
  const guideInput = document.getElementById('guideInput');
  const exp=getAdditionSteps(), step=state.guide, info=exp[step];
  const key = step==='ones'?'ro': step==='tens'?'rt':'rh';
  const val=guideInput.value;
  if (val==='') return;
  if (parseInt(val)===info.fullSum) {
    guideInput.classList.remove('incorrect'); guideInput.classList.add('correct');
    state.animating = true; render();
    await wait(500);
    // Place result digit in galera
    G[key].value = String(info.fullSum % 10);
    G[key].classList.add('correct');
    // Animate carry if needed
    if (info.fullSum >= 10 && step !== 'hundreds') {
      const carryKey = step==='ones'?'carry-t':'carry-h';
      await animateCarryFlyUp(G[key].id, carryKey, '1');
    }
    guideInput.value = '';
    guideInput.classList.remove('correct','incorrect');
    state.animating = false;
    // Advance step
    let next;
    if (step==='ones') next='tens';
    else if (step==='tens') next=exp.needsHundreds?'hundreds':'done';
    else next='done';
    state.guide=next; render();
    if (next==='done') { celebrate(); state.answered=true; }
    else { guideInput.focus(); }
  } else {
    guideInput.classList.remove('correct'); guideInput.classList.add('incorrect');
    showHint();
  }
}
function toggleGuide() {
  state.guideEnabled = !state.guideEnabled;
  const guideInput = document.getElementById('guideInput');
  guideInput.value = '';
  guideInput.classList.remove('correct','incorrect');
  if (!state.guideEnabled) {
    state.guide = null;
  } else if (state.num1>0 && state.num2>0 && !state.answered) {
    clearGaleraResults(); state.guide='ones'; state.answered=false;
  }
  render();
  if (state.guide) guideInput.focus();
}

// ═══════════════════════════════════════════
// Input Handling — Calculator-style entry
// ═══════════════════════════════════════════
state.entryTarget = 'a1'; // 'a1' or 'a2' — which operand is being entered

function shiftDigitLeft(prefix) {
  // Shift digits left: tens←ones, hundreds←tens, new digit goes to ones
  const h = G[prefix+'h'], t = G[prefix+'t'], o = G[prefix+'o'];
  h.value = t.value; t.value = o.value; o.value = '';
}
function shiftDigitRight(prefix) {
  // Shift digits right (backspace): ones←tens, tens←hundreds, hundreds cleared
  const h = G[prefix+'h'], t = G[prefix+'t'], o = G[prefix+'o'];
  o.value = t.value; t.value = h.value; h.value = '';
}
function pushDigit(prefix, digit) {
  const h = G[prefix+'h'], t = G[prefix+'t'], o = G[prefix+'o'];
  if (h.value) return; // already 3 digits, ignore
  shiftDigitLeft(prefix);
  o.value = digit;
  dismissEntryHint();
}
function popDigit(prefix) {
  const o = G[prefix+'o'];
  if (!o.value && !G[prefix+'t'].value && !G[prefix+'h'].value) return;
  o.value = '';
  shiftDigitRight(prefix);
}
function syncStateFromGalera() {
  const {num1,num2} = readGaleraAddends();
  state.num1=num1; state.num2=num2;
  if (state.phase !== 'input') {
    state.phase='input'; state.carries={tens:0,hundreds:0};
    state.combined={ones:0,tens:0,hundreds:0};
    state.regrouped={ones:0,tens:0,hundreds:0};
    clearGaleraResults();
  }
  state.answered=false;
  const guideInput = document.getElementById('guideInput');
  guideInput.value = '';
  guideInput.classList.remove('correct','incorrect');
  if (state.guideEnabled) {
    state.guide = (state.num1>0 && state.num2>0) ? 'ones' : null;
    clearGaleraResults();
  }
  renderMatInput(); render();
}
function confirmAndJump(target) {
  state.entryTarget = target;
  G[target+'o'].focus();
}
function confirmBothAndStart() {
  syncStateFromGalera();
  if (state.num1>0 && state.num2>0) {
    if (state.guide) document.getElementById('guideInput').focus();
    else G.ro.focus();
  }
}

// All addend cells: prevent default input, use keydown for calculator-style
const addendCells = ['a1h','a1t','a1o','a2h','a2t','a2o'];
addendCells.forEach(k => {
  G[k].addEventListener('input', function(e) {
    // Prevent direct typing — handled by keydown
    this.value = this.value.replace(/[^0-9]/g,'');
  });
});
// Keydown handler on addend cells
addendCells.forEach(k => {
  G[k].addEventListener('keydown', function(e) {
    const prefix = state.entryTarget;
    if (e.key >= '0' && e.key <= '9') {
      e.preventDefault();
      pushDigit(prefix, e.key);
      syncStateFromGalera();
      G[prefix+'o'].focus();
    } else if (e.key === 'Backspace') {
      e.preventDefault();
      popDigit(prefix);
      syncStateFromGalera();
      G[prefix+'o'].focus();
    } else if (e.key === 'Enter' || e.key === 'Tab' || e.key === '+') {
      e.preventDefault();
      if (prefix === 'a1') {
        syncStateFromGalera();
        confirmAndJump('a2');
      } else {
        confirmBothAndStart();
      }
    } else if (e.key === 'Escape') {
      e.preventDefault();
      this.blur();
    }
  });
});
// Click on any addend cell sets entryTarget to that operand
addendCells.forEach(k => {
  G[k].addEventListener('focus', function() {
    state.entryTarget = k.startsWith('a1') ? 'a1' : 'a2';
  });
});

['rh','rt','ro'].forEach(k=>{
  G[k].addEventListener('input', function(){
    this.value=this.value.replace(/[^0-9]/g,'').slice(0,1);
    this.classList.remove('correct','incorrect');
  });
  G[k].addEventListener('keydown', function(e){
    if (e.key === 'Enter') {
      e.preventDefault();
      const {num1,num2}=readGaleraAddends();
      state.num1=num1; state.num2=num2;
      if (state.num1>0 && state.num2>0) checkAnswer();
    }
  });
});
// Carry inputs — editable, filter to digits
['ch','ct'].forEach(k=>{
  G[k].addEventListener('input', function(){
    this.value=this.value.replace(/[^0-9]/g,'').slice(0,1);
  });
});
// Guide input handler
document.getElementById('guideInput').addEventListener('input', function(){
  this.value=this.value.replace(/[^0-9]/g,'').slice(0,2);
  this.classList.remove('correct','incorrect');
  if (this.value) checkGuideStep();
});
document.getElementById('guideInput').addEventListener('focus', dismissEstimate);
['rh','rt','ro'].forEach(k => G[k].addEventListener('focus', dismissEstimate));

// ═══════════════════════════════════════════
// Block counting
// ═══════════════════════════════════════════
document.getElementById('theMat').addEventListener('click', (e) => {
  const block = e.target.closest('.block');
  if (!block || state.animating) return;
  block.classList.toggle('counted');
  updateCountBar();
});

// ═══════════════════════════════════════════
// Collapse toggle
// ═══════════════════════════════════════════
document.getElementById('matToggle').addEventListener('click', () => {
  const next = !state.matCollapsed;
  localStorage.setItem('matCollapsed', next);
  setState({ matCollapsed: next });
});
document.getElementById('numlineToggle').addEventListener('click', () => {
  setState({ numlineCollapsed: !state.numlineCollapsed });
});
document.getElementById('expandedToggle').addEventListener('click', () => {
  setState({ expandedCollapsed: !state.expandedCollapsed });
});

// ═══════════════════════════════════════════
// Undo on destructive actions
// ═══════════════════════════════════════════
let undoSnapshot = null;
let undoTimer = null;
const galCellIds = ['g-a1-h','g-a1-t','g-a1-o','g-a2-h','g-a2-t','g-a2-o','g-r-h','g-r-t','g-r-o','carry-h','carry-t'];
function hasPartialWork() {
  return ['g-r-h','g-r-t','g-r-o','carry-h','carry-t'].some(id => {
    const el = document.getElementById(id);
    return el && el.value.trim() !== '';
  });
}
function takeSnapshot() {
  const cells = {};
  galCellIds.forEach(id => { const el = document.getElementById(id); cells[id] = el ? el.value : ''; });
  return { cells, num1: state.num1, num2: state.num2, phase: state.phase,
    carries: {...state.carries}, combined: {...state.combined},
    regrouped: {...state.regrouped}, answered: state.answered,
    guide: state.guide, guideEnabled: state.guideEnabled };
}
function restoreSnapshot(snap) {
  Object.entries(snap.cells).forEach(([id, val]) => { const el = document.getElementById(id); if (el) el.value = val; });
  state.num1 = snap.num1; state.num2 = snap.num2; state.phase = snap.phase;
  state.carries = snap.carries; state.combined = snap.combined;
  state.regrouped = snap.regrouped; state.answered = snap.answered;
  state.guide = snap.guide; state.guideEnabled = snap.guideEnabled;
  renderMatInput(); render();
}
function dismissUndoToast() {
  document.querySelectorAll('.undo-toast').forEach(t => t.remove());
  if (undoTimer) { clearTimeout(undoTimer); undoTimer = null; }
  undoSnapshot = null;
}
function showUndoToast(label) {
  dismissUndoToast();
  const snap = takeSnapshot();
  const t = document.createElement('div');
  t.className = 'undo-toast';
  t.innerHTML = label + ' <button id="undoBtn">Undo</button>';
  document.body.appendChild(t);
  // perform the action after snapshot
  return function commitUndo() {
    undoSnapshot = snap;
    const btn = document.getElementById('undoBtn');
    if (btn) btn.addEventListener('click', () => {
      restoreSnapshot(undoSnapshot);
      dismissUndoToast();
    });
    undoTimer = setTimeout(() => {
      const toast = document.querySelector('.undo-toast');
      if (toast) { toast.classList.add('fade-out'); toast.addEventListener('animationend', () => toast.remove(), {once:true}); }
      undoSnapshot = null; undoTimer = null;
    }, 3000);
  };
}

// ═══════════════════════════════════════════
// Event Listeners
// ═══════════════════════════════════════════
document.getElementById('estimateInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); checkEstimate(); }
  else if (e.key === 'Escape') { e.preventDefault(); dismissEstimate(); }
});
document.getElementById('estimateInput').addEventListener('input', function() {
  this.value = this.value.replace(/[^0-9]/g, '');
});
document.getElementById('btnClear').addEventListener('click', () => {
  let commit = null;
  if (hasPartialWork()) commit = showUndoToast('Cleared.');
  clearConfetti();
  document.getElementById('feedbackOverlay').classList.remove('show');
  document.querySelectorAll('.hint-toast').forEach(e=>e.remove());
  G.a1h.value=''; G.a1t.value=''; G.a1o.value='';
  G.a2h.value=''; G.a2t.value=''; G.a2o.value='';
  state.num1=0; state.num2=0;
  state.guide = state.guideEnabled ? 'ones' : null;
  state.entryTarget = 'a1';
  resetToInput(); render();
  G.a1o.focus();
  if (commit) commit();
});
document.getElementById('btnNew').addEventListener('click', () => {
  let commit = null;
  if (hasPartialWork()) commit = showUndoToast('New problem.');
  newProblem();
  if (commit) commit();
});
document.getElementById('btnGuide').addEventListener('click', toggleGuide);
document.getElementById('btnCombine').addEventListener('click', () => {
  if (state.num1>0 && state.num2>0) doCombine();
});
document.getElementById('btnRegroup').addEventListener('click', doRegroup);
document.getElementById('btnCheck').addEventListener('click', () => {
  const {num1,num2}=readGaleraAddends();
  state.num1=num1; state.num2=num2;
  if (state.num1>0 && state.num2>0) checkAnswer();
});
document.getElementById('difficultySelect').addEventListener('change', function(){
  state.difficulty=this.value;
});
// ═══════════════════════════════════════════
// Init
// ═══════════════════════════════════════════
newProblem();
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
